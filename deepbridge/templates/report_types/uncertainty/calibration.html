{% from "components/charts/line_chart.html" import line_chart %}

<div class="calibration-section">
    <div class="card">
        <h2>Calibration Analysis</h2>
        <p>This section analyzes how well the model's prediction intervals are calibrated across different confidence levels.</p>
        
        <div id="calibration-chart-container">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <div id="width-chart-container">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const reportData = JSON.parse('{{ report_data|safe }}');
        
        // Create calibration chart
        if (reportData.crqr && reportData.crqr.by_alpha) {
            const alphas = Object.keys(reportData.crqr.by_alpha).map(a => parseFloat(a));
            alphas.sort((a, b) => a - b);
            
            const alphaLabels = alphas.map(a => a.toString());
            const ratios = [];
            const widths = [];
            
            alphas.forEach(alpha => {
                const alphaStr = alpha.toString();
                const alphaData = reportData.crqr.by_alpha[alphaStr];
                
                if (alphaData && alphaData.overall_result) {
                    const actual = alphaData.overall_result.coverage || 0;
                    const expected = alphaData.overall_result.expected_coverage || 0;
                    
                    // Calculate ratio (1.0 means perfect calibration)
                    const ratio = expected > 0 ? actual / expected : 0;
                    ratios.push(ratio);
                    
                    // Get interval width
                    widths.push(alphaData.overall_result.mean_width || 0);
                } else {
                    ratios.push(null);
                    widths.push(null);
                }
            });
            
            // Create calibration chart
            const calibrationContainer = document.getElementById('calibration-chart-container');
            const calibrationChartId = 'calibration-chart';
            calibrationContainer.innerHTML = `
                <h3>Coverage Calibration Ratio</h3>
                <p>Ideal ratio is 1.0. Values below 1.0 indicate undercoverage, above 1.0 indicate overcoverage.</p>
                <div id="${calibrationChartId}" style="height: 400px;"></div>
            `;
            
            // Plot calibration chart
            Plotly.newPlot(calibrationChartId, [
                {
                    x: alphaLabels,
                    y: ratios,
                    mode: 'lines+markers',
                    type: 'scatter',
                    name: 'Calibration Ratio',
                    line: {
                        color: 'rgba(46, 204, 113, 0.8)',
                        width: 3
                    },
                    marker: {
                        size: 10,
                        color: 'rgba(46, 204, 113, 0.8)'
                    }
                },
                {
                    x: alphaLabels,
                    y: Array(alphaLabels.length).fill(1.0),
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Ideal Calibration',
                    line: {
                        color: 'rgba(0, 0, 0, 0.3)',
                        width: 2,
                        dash: 'dash'
                    }
                }
            ], {
                xaxis: {
                    title: 'Alpha Level',
                    tickformat: '.2f'
                },
                yaxis: {
                    title: 'Actual/Expected Coverage Ratio',
                    range: [0, Math.max(1.5, ...ratios) * 1.1]
                },
                margin: {
                    l: 60,
                    r: 30,
                    t: 20,
                    b: 60
                },
                legend: {
                    orientation: 'h',
                    y: 1.1
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(248,249,250,0.5)'
            }, {
                responsive: true
            });
            
            // Create width chart
            const widthContainer = document.getElementById('width-chart-container');
            const widthChartId = 'width-chart';
            widthContainer.innerHTML = `
                <h3>Prediction Interval Width</h3>
                <p>Shows how the prediction interval width changes across different confidence levels.</p>
                <div id="${widthChartId}" style="height: 400px;"></div>
            `;
            
            // Plot width chart
            Plotly.newPlot(widthChartId, [
                {
                    x: alphaLabels,
                    y: widths,
                    mode: 'lines+markers',
                    type: 'scatter',
                    name: 'Interval Width',
                    marker: {
                        size: 10,
                        color: 'rgba(52, 152, 219, 0.8)'
                    },
                    line: {
                        width: 3,
                        color: 'rgba(52, 152, 219, 0.8)'
                    }
                }
            ], {
                xaxis: {
                    title: 'Alpha Level',
                    tickformat: '.2f'
                },
                yaxis: {
                    title: 'Average Interval Width',
                    tickformat: '.3f'
                },
                margin: {
                    l: 60,
                    r: 30,
                    t: 20,
                    b: 60
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(248,249,250,0.5)'
            }, {
                responsive: true
            });
        } else {
            // No CRQR data available
            document.getElementById('calibration-chart-container').innerHTML = `
                <div class="alert alert-info">
                    <p>No calibration data available for this model.</p>
                </div>
            `;
            
            document.getElementById('width-chart-container').innerHTML = '';
        }
    });
</script>

<style>
    .calibration-section {
        margin-bottom: 30px;
    }
    
    .calibration-section h3 {
        margin-top: 30px;
        margin-bottom: 10px;
        font-size: 18px;
    }
    
    .calibration-section p {
        margin-bottom: 20px;
        color: #666;
    }
</style>