{% extends "base.html" %}

{% block title %}DeepBridge Uncertainty Report{% endblock %}

{% block head %}
<style>
    .uncertainty-score-indicator {
        text-align: center;
        margin: 30px 0;
    }
    
    .score-circle {
        display: inline-block;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: conic-gradient(
            var(--primary-color) calc({{ uncertainty_score|float * 360 }}deg),
            #e9ecef calc({{ uncertainty_score|float * 360 }}deg) 360deg
        );
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .score-inner {
        position: absolute;
        top: 15px;
        left: 15px;
        right: 15px;
        bottom: 15px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    
    .score-value {
        font-size: 32px;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .score-label {
        font-size: 14px;
        color: #666;
    }
    
    .metrics-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metrics-container > div {
        flex: 1 0 250px;
    }
    
    @media (max-width: 768px) {
        .metrics-container > div {
            flex: 1 0 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
    {# Summary Section #}
    {% include "report_types/uncertainty/summary.html" %}
    
    {# Tabs Navigation #}
    {% from "components/ui/tabs.html" import tabs %}
    {{ tabs([
        {"id": "overview", "title": "Overview", "active": true},
        {"id": "calibration", "title": "Calibration Analysis"},
        {"id": "details", "title": "Detailed Results"}
    ]) }}
    
    {# Tab Contents #}
    <div id="overview" class="tab-content active">
        {% include "report_types/uncertainty/overview.html" %}
    </div>
    
    <div id="calibration" class="tab-content">
        {% include "report_types/uncertainty/calibration.html" %}
    </div>
    
    <div id="details" class="tab-content">
        {% include "report_types/uncertainty/details.html" %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize with report data
    document.addEventListener('DOMContentLoaded', function() {
        // Parse the report data
        window.reportData = JSON.parse('{{ report_data_json|safe }}');
        console.log('Report data loaded:', reportData);
        
        // Ensure Plotly is loaded
        if (typeof Plotly === 'undefined') {
            console.error('Plotly is not loaded. Loading it dynamically...');
            var script = document.createElement('script');
            script.src = 'https://cdn.plot.ly/plotly-2.29.1.min.js';
            script.onload = function() {
                console.log('Plotly loaded successfully');
                // Trigger rendering of all charts
                renderAllCharts();
            };
            document.head.appendChild(script);
        } else {
            console.log('Plotly is already loaded');
            // Small delay to ensure the DOM is fully ready
            setTimeout(renderAllCharts, 100);
        }
        
        // Function to trigger all chart renderings
        function renderAllCharts() {
            // Dispatch a custom event that component scripts will listen for
            document.dispatchEvent(new CustomEvent('renderCharts'));
        }
    });
</script>
{% endblock %}

{% block component_scripts %}
<script>
    // Function to render all uncertainty charts
    function renderAllUncertaintyCharts() {
        if (!window.reportData || typeof Plotly === 'undefined') {
            console.error('Cannot render uncertainty charts: reportData or Plotly not available');
            return;
        }
        console.log('Rendering all uncertainty charts...');

    // Scripts from component templates run here after reportData is initialized
        // Initialize charts and tables based on reportData
        
        // Overview charts
        const calibrationContainer = document.getElementById('calibration-chart-container');
        if (calibrationContainer && reportData.crqr && reportData.crqr.by_alpha) {
            // Process and display calibration chart...
        }
        
        // Detail tables
        const detailsContainer = document.getElementById('uncertainty-details-container');
        if (detailsContainer && reportData.crqr && reportData.crqr.by_alpha) {
            // Create detailed tables...
        }
    } // End of renderAllUncertaintyCharts function
    
    // Call render function when DOM is loaded
    document.addEventListener('DOMContentLoaded', renderAllUncertaintyCharts);
    
    // Also listen for the custom event triggered after reportData is loaded
    document.addEventListener('renderCharts', renderAllUncertaintyCharts);
</script>
{% endblock %}