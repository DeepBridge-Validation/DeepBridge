{% from "components/tables/data_table.html" import data_table %}

<div class="details-section">
    <div class="card">
        <h2>Detailed Uncertainty Results</h2>
        
        <div class="metrics-details">
            <h3>Model Metrics</h3>
            <div id="metrics-table-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="alpha-level-details">
            <h3>Results by Alpha Level</h3>
            <div id="alpha-details-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const reportData = JSON.parse('{{ report_data|safe }}');
        
        // Display model metrics
        const metricsContainer = document.getElementById('metrics-table-container');
        if (reportData.metrics) {
            const metricsData = [];
            for (const [key, value] of Object.entries(reportData.metrics)) {
                metricsData.push([
                    key,
                    typeof value === 'number' ? value.toFixed(4) : value
                ]);
            }
            
            metricsContainer.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${metricsData.map(row => `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${row[1]}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            metricsContainer.innerHTML = '<p>No metrics data available.</p>';
        }
        
        // Display detailed results by alpha level
        const alphaDetailsContainer = document.getElementById('alpha-details-container');
        if (reportData.crqr && reportData.crqr.by_alpha) {
            const alphas = Object.keys(reportData.crqr.by_alpha);
            alphas.sort((a, b) => parseFloat(a) - parseFloat(b));
            
            let alphaDetailsHTML = '';
            
            alphas.forEach(alpha => {
                const alphaData = reportData.crqr.by_alpha[alpha];
                
                if (alphaData && alphaData.overall_result) {
                    const result = alphaData.overall_result;
                    
                    alphaDetailsHTML += `
                        <div class="alpha-detail-card">
                            <h4>Alpha Level: ${alpha}</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Coverage</td>
                                        <td>${result.coverage ? (result.coverage * 100).toFixed(2) + '%' : 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td>Expected Coverage</td>
                                        <td>${result.expected_coverage ? (result.expected_coverage * 100).toFixed(2) + '%' : 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td>Coverage Ratio</td>
                                        <td>${result.coverage && result.expected_coverage ? (result.coverage / result.expected_coverage).toFixed(2) : 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td>Mean Interval Width</td>
                                        <td>${result.mean_width ? result.mean_width.toFixed(4) : 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td>Standard Deviation of Width</td>
                                        <td>${result.std_width ? result.std_width.toFixed(4) : 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });
            
            if (alphaDetailsHTML) {
                alphaDetailsContainer.innerHTML = alphaDetailsHTML;
            } else {
                alphaDetailsContainer.innerHTML = '<p>No detailed alpha level results available.</p>';
            }
        } else {
            alphaDetailsContainer.innerHTML = '<p>No detailed alpha level results available.</p>';
        }
    });
</script>

<style>
    .details-section {
        margin-bottom: 30px;
    }
    
    .metrics-details,
    .alpha-level-details {
        margin-bottom: 30px;
    }
    
    .alpha-detail-card {
        margin-bottom: 25px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .alpha-detail-card h4 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        color: #444;
    }
</style>