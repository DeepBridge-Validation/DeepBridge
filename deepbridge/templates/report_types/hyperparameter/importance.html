{% from "components/charts/bar_chart.html" import bar_chart %}

<div class="importance-section">
    <div class="card">
        <h2>Hyperparameter Importance</h2>
        <p>This analysis shows the relative importance of each hyperparameter to model performance.</p>
        
        <div id="importance-chart-container">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <div id="importance-table-container">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const reportData = JSON.parse('{{ report_data|safe }}');
        
        // Create importance chart
        if (reportData.importance_scores) {
            const importanceScores = reportData.importance_scores;
            
            // Convert to array of [param, score] pairs
            const importanceEntries = Object.entries(importanceScores);
            
            // Sort by importance score (descending)
            importanceEntries.sort((a, b) => b[1] - a[1]);
            
            // Prepare data for chart
            const paramNames = importanceEntries.map(entry => entry[0]);
            const scores = importanceEntries.map(entry => entry[1]);
            
            // Create chart container
            const chartContainer = document.getElementById('importance-chart-container');
            const chartId = 'importance-chart';
            chartContainer.innerHTML = `
                <div id="${chartId}" style="height: 500px;"></div>
            `;
            
            // Create horizontal bar chart
            Plotly.newPlot(chartId, [{
                y: paramNames,
                x: scores,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: scores.map(score => {
                        // Color gradient based on score
                        const normalizedScore = score / Math.max(...scores);
                        return `rgba(52, 152, 219, ${0.3 + 0.7 * normalizedScore})`;
                    })
                }
            }], {
                title: 'Hyperparameter Importance',
                xaxis: { 
                    title: 'Importance Score',
                    tickformat: '.3f'
                },
                yaxis: {
                    title: 'Hyperparameter',
                    automargin: true
                },
                margin: { l: 150, r: 30, t: 40, b: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(248,249,250,0.5)'
            }, { responsive: true });
            
            // Create importance table
            const tableContainer = document.getElementById('importance-table-container');
            tableContainer.innerHTML = `
                <h3>Hyperparameter Importance Rankings</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Hyperparameter</th>
                            <th>Importance Score</th>
                            <th>Relative Importance (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${importanceEntries.map(([param, score]) => `
                            <tr>
                                <td>${param}</td>
                                <td>${score.toFixed(4)}</td>
                                <td>${(score / importanceEntries[0][1] * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            // No importance scores available
            document.getElementById('importance-chart-container').innerHTML = `
                <div class="alert alert-info">
                    <p>No hyperparameter importance data available for this model.</p>
                </div>
            `;
            
            document.getElementById('importance-table-container').innerHTML = '';
        }
    });
</script>

<style>
    .importance-section {
        margin-bottom: 30px;
    }
    
    .importance-section h3 {
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 18px;
    }
    
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
</style>