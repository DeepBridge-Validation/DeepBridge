{% from "components/tables/data_table.html" import data_table %}

<div class="details-section">
    <div class="card">
        <h2>Detailed Hyperparameter Results</h2>
        
        <div class="metrics-details">
            <h3>Model Metrics</h3>
            <div id="metrics-table-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="trials-details">
            <h3>Trial Results</h3>
            <div id="trials-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const reportData = JSON.parse('{{ report_data|safe }}');
        
        // Display model metrics
        const metricsContainer = document.getElementById('metrics-table-container');
        if (reportData.metrics) {
            const metricsData = [];
            for (const [key, value] of Object.entries(reportData.metrics)) {
                metricsData.push([
                    key,
                    typeof value === 'number' ? value.toFixed(4) : value
                ]);
            }
            
            metricsContainer.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${metricsData.map(row => `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${row[1]}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            metricsContainer.innerHTML = '<p>No metrics data available.</p>';
        }
        
        // Display trial results
        const trialsContainer = document.getElementById('trials-container');
        if (reportData.trials && reportData.trials.length > 0) {
            // Get all hyperparameter names from the first trial
            const firstTrial = reportData.trials[0];
            const paramNames = Object.keys(firstTrial.params || {});
            
            // Create table headers
            let tableHTML = `
                <table class="data-table sortable">
                    <thead>
                        <tr>
                            <th>Trial</th>
                            <th>Score</th>
                            ${paramNames.map(name => `<th>${name}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add rows for each trial
            reportData.trials.forEach((trial, index) => {
                tableHTML += `
                    <tr ${trial.is_best ? 'class="best-trial"' : ''}>
                        <td>${index + 1}</td>
                        <td>${typeof trial.score === 'number' ? trial.score.toFixed(4) : trial.score}</td>
                        ${paramNames.map(name => `
                            <td>${trial.params && trial.params[name] !== undefined ? 
                                (typeof trial.params[name] === 'number' ? 
                                    trial.params[name].toFixed(6) : 
                                    trial.params[name]) : 
                                'N/A'}
                            </td>
                        `).join('')}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            trialsContainer.innerHTML = tableHTML;
        } else if (reportData.importance_results && reportData.importance_results.length > 0) {
            // Alternative display if we have importance results but not trial results
            const importanceResults = reportData.importance_results;
            
            // Create a summary table for importance analysis results
            trialsContainer.innerHTML = `
                <div class="importance-method-info">
                    <p>Hyperparameter importance was analyzed using ${importanceResults[0].method || 'parameter permutation'}.</p>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Analysis</th>
                            <th>Method</th>
                            <th>Parameters Analyzed</th>
                            <th>Optimization Metric</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${importanceResults.map((result, index) => `
                            <tr>
                                <td>Analysis ${index + 1}</td>
                                <td>${result.method || 'Parameter Permutation'}</td>
                                <td>${result.parameters ? result.parameters.length : 'All'}</td>
                                <td>${result.optimization_metric || reportData.optimization_metric || 'accuracy'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            trialsContainer.innerHTML = '<p>No detailed trial results available.</p>';
        }
    });
</script>

<style>
    .details-section {
        margin-bottom: 30px;
    }
    
    .metrics-details,
    .trials-details {
        margin-bottom: 30px;
    }
    
    .best-trial {
        background-color: rgba(46, 204, 113, 0.1) !important;
        font-weight: bold;
    }
    
    .importance-method-info {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .importance-method-info p {
        margin: 0;
    }
</style>