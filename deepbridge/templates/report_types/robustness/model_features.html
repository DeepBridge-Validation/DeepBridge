{% from "components/charts/bar_chart.html" import bar_chart %}
{% from "components/tables/data_table.html" import data_table %}

<div class="model-features-section">
    <div class="card">
        <h2>Model Feature Importance</h2>
        <p>This analysis shows the native feature importance extracted directly from the model. Features with higher scores have greater impact on the model's predictions.</p>
        
        <div id="model-feature-chart-container">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <div id="model-feature-table">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const reportData = JSON.parse('{{ report_data|safe }}');
        
        // Look for model feature importance data in various locations
        let modelFeatureData = null;

        // First check direct model_feature_importance field
        if (reportData.model_feature_importance && Object.keys(reportData.model_feature_importance).length > 0) {
            console.log('Model feature importance data found in reportData.model_feature_importance');
            modelFeatureData = reportData.model_feature_importance;
        } 
        // Then try nested paths
        else if (reportData.models && 
                reportData.models.primary_model && 
                reportData.models.primary_model.feature_importance &&
                Object.keys(reportData.models.primary_model.feature_importance).length > 0) {
            console.log('Model feature importance found in reportData.models.primary_model.feature_importance');
            modelFeatureData = reportData.models.primary_model.feature_importance;
        } 
        // Final fallback
        else if (reportData.initial_results && 
                reportData.initial_results.models && 
                reportData.initial_results.models.primary_model && 
                reportData.initial_results.models.primary_model.feature_importance &&
                Object.keys(reportData.initial_results.models.primary_model.feature_importance).length > 0) {
            console.log('Model feature importance found in reportData.initial_results.models.primary_model.feature_importance');
            modelFeatureData = reportData.initial_results.models.primary_model.feature_importance;
        }
        
        if (modelFeatureData) {
            // Convert to array of [feature, importance] pairs
            const featureEntries = Object.entries(modelFeatureData);
            
            // Sort by importance (descending)
            featureEntries.sort((a, b) => b[1] - a[1]);
            
            // Take top 15 for visualization
            const topFeatures = featureEntries.slice(0, 15);
            
            // Prepare data for chart
            const featureNames = topFeatures.map(item => item[0]);
            const importanceValues = topFeatures.map(item => item[1]);
            
            // Create the chart container
            const chartContainer = document.getElementById('model-feature-chart-container');
            const chartId = 'model-feature-chart';
            chartContainer.innerHTML = `
                <div id="${chartId}" style="height: 500px;"></div>
            `;
            
            // Create horizontal bar chart
            Plotly.newPlot(chartId, [{
                y: featureNames,
                x: importanceValues,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: importanceValues.map(score => {
                        // Color gradient based on score
                        const normalizedScore = score / Math.max(...importanceValues);
                        return `rgba(46, 204, 113, ${0.3 + 0.7 * normalizedScore})`;
                    })
                }
            }], {
                title: 'Model Native Feature Importance',
                xaxis: { 
                    title: 'Importance Score',
                    tickformat: '.3f'
                },
                yaxis: {
                    title: 'Feature',
                    automargin: true
                },
                margin: { l: 150, r: 30, t: 40, b: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(248,249,250,0.5)'
            }, { responsive: true });
            
            // Create feature importance table with all features
            const tableContainer = document.getElementById('model-feature-table');
            const tableData = featureEntries.map(([feature, importance]) => {
                return [
                    feature,
                    importance.toFixed(4),
                    ((importance / featureEntries[0][1]) * 100).toFixed(1) + '%'
                ];
            });
            
            tableContainer.innerHTML = `
                <h3>Model Feature Importance Rankings</h3>
                <table class="data-table sortable">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Importance Score</th>
                            <th>Relative Importance (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableData.map(row => `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${row[1]}</td>
                                <td>${row[2]}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            // No model feature importance data available
            document.getElementById('model-feature-chart-container').innerHTML = `
                <div class="alert alert-info">
                    <p>No native feature importance data available for this model.</p>
                    <p>This could be because the model type doesn't support feature importance extraction or the data wasn't included in the results.</p>
                </div>
            `;
        }
    });
</script>

<style>
    .model-features-section {
        margin-bottom: 30px;
    }
    
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
</style>