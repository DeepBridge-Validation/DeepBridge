<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepBridge {{ report_type|capitalize }} Report: {{ report_data.model_name }}</title>
    
    <!-- Global error handler - load first to catch syntax errors early -->
    <script>
        // Simple inline error handler to catch syntax errors
        window.onerror = function(message, source, lineno, colno, error) {
            if (message && (message.includes("Illegal continue") || message.includes("no surrounding iteration"))) {
                console.error("Caught illegal continue:", {message, source, lineno});
                return true; // Prevent default handling
            }
            return false; // Let other errors propagate
        };
    </script>
    
    <!-- Favicon -->
    {% if favicon_base64 %}
    <link rel="icon" href="data:image/png;base64,{{ favicon_base64 }}" type="image/png">
    {% endif %}
    
    <!-- Plotly library (incluído como conteúdo inline para garantir autonomia) -->
    <script>
        /* Plotly.js will be loaded from CDN the first time, but we'll add a fallback mechanism */
        (function() {
            window.loadPlotly = function() {
                if (typeof Plotly !== 'undefined') {
                    console.log("Plotly is already loaded");
                    return Promise.resolve();
                }
                
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.plot.ly/plotly-2.29.1.min.js';
                    script.async = true;
                    
                    script.onload = function() {
                        console.log("Plotly loaded successfully");
                        resolve();
                    };
                    
                    script.onerror = function() {
                        console.error("Failed to load Plotly from CDN, using simplified displays");
                        reject(new Error("Failed to load Plotly"));
                    };
                    
                    document.head.appendChild(script);
                });
            };
            
            // Attempt to load Plotly when the page loads
            window.addEventListener('DOMContentLoaded', function() {
                window.loadPlotly().catch(error => {
                    console.warn("Will use fallback charts:", error);
                });
            });
        })();
    </script>
    
    <!-- CSS combinado -->
    <style>
        {{ css_content }}
    </style>
</head>
<body>
    <div class="report-container {{ report_type }}-report">
        <!-- Header comum -->
        {% include 'common/header.html' %}

        <!-- Summary section (inserido diretamente como o header) -->
        {% include 'report_types/' + report_type + '/partials/summary.html' %}

        <div class="report-content">
            <!-- Navegação em abas usando componente comum -->
            {% with 
                tabs=[
                    {'id': 'overview', 'title': 'Overview'},
                    {'id': 'details', 'title': 'Details'},
                    {'id': 'boxplot', 'title': 'Box Plot'},
                    {'id': 'feature_impact', 'title': 'Feature Importance'},
                    {'id': 'importance_comparison', 'title': 'Importance Comparison'}
                ]
            %}
            {% include 'common/navigation.html' %}
            {% endwith %}

            <!-- Conteúdo das abas -->
            <div id="overview" class="tab-content active">
                {% include 'report_types/' + report_type + '/partials/overview.html' %}
            </div>
            
            <div id="details" class="tab-content">
                {% include 'report_types/' + report_type + '/partials/details.html' %}
            </div>
            
            <div id="boxplot" class="tab-content">
                {% include 'report_types/' + report_type + '/partials/boxplot.html' %}
            </div>
            
            <div id="feature_impact" class="tab-content">
                {% include 'report_types/' + report_type + '/partials/features.html' %}
            </div>
            
            <div id="importance_comparison" class="tab-content">
                {% include 'report_types/' + report_type + '/partials/importance_comparison_fixed.html' %}
            </div>
        </div>
        
        <!-- Footer comum -->
        {% include 'common/footer.html' %}
    </div>

    <!-- Inicialização de dados do relatório -->
    <script>
        // Disponibilizar dados do relatório para todos os componentes
        window.reportData = {{ report_data_json|safe }};
        
        // Configuração básica do relatório
        window.reportConfig = {
            reportType: '{{ report_type }}',
            modelName: '{{ report_data.model_name }}',
            // Incluir dados de importância de características diretamente para acesso mais fácil
            feature_importance: {{ report_data.feature_importance|tojson|default('{}') }},
            model_feature_importance: {{ report_data.model_feature_importance|tojson|default('{}') }},
            feature_subset: {{ report_data.feature_subset|tojson|default('[]') }}
        };
        
        // Extrair dados do gráfico, se disponíveis
        if (window.reportData && window.reportData.chart_data_json) {
            try {
                // Limpar dados JSON antes de analisar
                const jsonStr = window.reportData.chart_data_json;
                let cleanJson = jsonStr;
                
                // Corrigir vírgulas finais
                cleanJson = cleanJson.replace(/,(\s*})/g, '$1');
                cleanJson = cleanJson.replace(/,(\s*\])/g, '$1');
                
                // Tratar outros problemas de sintaxe
                cleanJson = cleanJson.replace(/\bNaN\b/g, 'null');
                cleanJson = cleanJson.replace(/\bInfinity\b/g, 'null');
                cleanJson = cleanJson.replace(/\b-Infinity\b/g, 'null');
                cleanJson = cleanJson.replace(/\bundefined\b/g, 'null');
                
                // Analisar os dados JSON limpos
                window.chartData = JSON.parse(cleanJson);
                console.log("Dados de gráfico carregados com sucesso");
            } catch (e) {
                console.error("Erro ao analisar dados do gráfico:", e);
                window.chartData = {
                    perturbation_levels: [],
                    feature_importance: {},
                    model_feature_importance: {},
                    boxplot_data: { models: [] }
                };
            }
        }
    </script>
    
    <!-- Scripts combinados para funcionalidade completa -->
    <script>
        // Todos os scripts são combinados e injetados diretamente no HTML
        // para garantir que o relatório seja totalmente autônomo
        
        /**
         * Namespace safety preloader to prevent duplicate declarations
         * This will be defined before any other scripts to ensure module registration works
         */
        window.__deepbridge_loaded_modules = window.__deepbridge_loaded_modules || {};
        
        /**
         * Function to safely register a module and prevent duplication
         * This is used to prevent "BoxplotChartManager already declared" errors
         */
        function registerModule(name, factory) {
            if (window.__deepbridge_loaded_modules[name]) {
                console.log(`Module ${name} already registered, using existing instance`);
                return window.__deepbridge_loaded_modules[name];
            }
            console.log(`Registering module ${name}`);
            const module = factory();
            window.__deepbridge_loaded_modules[name] = module;
            return module;
        }
        
        // Código para inicialização segura - garantir que seja executado apenas quando o DOM estiver pronto
        window.DeepBridgeInit = function() {
            console.log("DeepBridge report initialization - autonomous mode");
            
            // Tentar carregar Plotly se ainda não estiver carregado
            window.loadPlotly().catch(e => console.warn("Chart functionality may be limited", e));
            
            // Call initialization functions if defined
            if (typeof setupTabNavigation === 'function') {
                setupTabNavigation();
                console.log("Tab navigation initialized");
            }
            
            if (typeof initializeControllers === 'function') {
                initializeControllers();
                console.log("Controllers initialized");
            }
            
            // Initialize first tab's charts
            const initialTab = document.querySelector('.tab-btn.active');
            if (initialTab) {
                const tabId = initialTab.getAttribute('data-tab');
                if (typeof handleTabChange === 'function') {
                    handleTabChange(tabId);
                    console.log(`Initial tab ${tabId} initialized`);
                }
            } else {
                // Default to overview if no tab is active
                if (typeof ChartInitializer !== 'undefined' && 
                    typeof ChartInitializer.initializeOverviewCharts === 'function') {
                    ChartInitializer.initializeOverviewCharts();
                    console.log("Overview charts initialized by default");
                }
            }
        };
        
        // Código de todos os scripts combinados
        {{ js_content }}
        
        // Garantir que a inicialização ocorra quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM content loaded - initializing report...");
            
            // Uma pequena pausa para garantir que todos os dados estão disponíveis
            setTimeout(function() {
                if (typeof window.DeepBridgeInit === 'function') {
                    try {
                        window.DeepBridgeInit();
                    } catch (e) {
                        console.error("Error during initialization:", e);
                        
                        // Fallback initialization
                        initFallbackMode();
                    }
                } else {
                    console.warn("DeepBridgeInit não disponível - usando inicialização alternativa");
                    initFallbackMode();
                }
            }, 100);
        });
        
        // Fallback initialization function
        function initFallbackMode() {
            console.log("Using fallback mode initialization");
            
            // Inicializar abas
            const tabButtons = document.querySelectorAll('.tab-btn');
            if (tabButtons.length > 0) {
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // Desativar todas as abas
                        document.querySelectorAll('.tab-content').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        
                        // Ativar a aba selecionada
                        const selectedTab = document.getElementById(targetTab);
                        if (selectedTab) {
                            selectedTab.classList.add('active');
                        }
                        
                        // Desativar todos os botões
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Ativar o botão selecionado
                        this.classList.add('active');
                    });
                });
                
                // Ativar a primeira aba por padrão
                tabButtons[0].click();
            }
        }
    </script>
</body>
</html>