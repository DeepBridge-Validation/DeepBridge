{% from "components/charts/bar_chart.html" import bar_chart %}
{% from "components/tables/data_table.html" import data_table %}
{% include "components/ui/subtabs.html" %}

<div class="feature-importance-section">
    <div class="card">
        <h2>Feature Importance Analysis</h2>
        <p>This section shows different types of feature importance analysis to help understand which features have the greatest impact on model performance.</p>
        
        <div class="subtabs-container">
            <div class="subtabs" data-parent="features">
                <div class="subtab active" data-subtab="robustness_importance" data-parent="features">
                    Robustness Importance
                </div>
                <div class="subtab" data-subtab="model_importance" data-parent="features">
                    Model Importance
                </div>
                <div class="subtab" data-subtab="comparison" data-parent="features">
                    Importance Comparison
                </div>
            </div>
        </div>

        <!-- Robustness Importance Content -->
        <div id="robustness_importance" class="subtab-content active" data-parent="features">
            <div class="robustness-importance-container">
                <h3>Robustness Feature Importance</h3>
                <p>Higher values indicate features that have a greater impact on model robustness when perturbed.</p>
                
                <div id="feature-importance-container">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <div id="feature-importance-table">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Model Importance Content -->
        <div id="model_importance" class="subtab-content" data-parent="features">
            <div class="model-importance-container">
                <h3>Model Feature Importance</h3>
                <p>Features with higher scores have greater impact on the model's predictions according to the model's internal metrics.</p>
                
                <div id="model-features-container">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <div id="model-features-table">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Comparison Content -->
        <div id="comparison" class="subtab-content" data-parent="features">
            <div class="importance-comparison-container">
                <h3>Feature Importance Comparison</h3>
                <p>This visualization compares robustness importance with model-derived importance to identify any differences.</p>
                
                <div id="importance-comparison-container">
                    <p>The chart below shows a comparison between robustness-based feature importance and the model's internal feature importance.</p>
                    <div id="importance-comparison-chart">
                        <!-- Will be populated by JavaScript if both sets of data are available -->
                    </div>
                    
                    <div id="importance-comparison-table">
                        <!-- Will be populated by JavaScript if both sets of data are available -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .feature-importance-section {
        margin-bottom: 30px;
    }
    
    .card {
        margin-bottom: 30px;
    }
    
    .robustness-importance-container,
    .model-importance-container,
    .importance-comparison-container {
        margin-bottom: 20px;
    }
    
    .robustness-importance-container h3,
    .model-importance-container h3,
    .importance-comparison-container h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
        color: #2c3e50;
    }
    
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .feature-table {
        margin-top: 20px;
        width: 100%;
        border-collapse: collapse;
    }
    
    .feature-table th, .feature-table td {
        padding: 8px 12px;
        text-align: left;
        border: 1px solid #ddd;
    }
    
    .feature-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .feature-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    #feature-importance-container,
    #model-features-container,
    #importance-comparison-chart {
        min-height: 400px;
        margin: 20px 0;
    }
</style>

<!-- Add JavaScript to generate comparison chart -->
<script>
document.addEventListener('renderCharts', function() {
    setTimeout(function() {
        // Check if we have both types of feature importance data
        if (window.reportData && 
            ((reportData.feature_importance && reportData.model_feature_importance) ||
             (reportData.results && 
              reportData.results.robustness && 
              reportData.results.robustness.results && 
              reportData.results.robustness.results.primary_model && 
              reportData.results.robustness.results.primary_model.feature_importance && 
              reportData.results.robustness.results.primary_model.model_feature_importance))) {
              
            const comparisonChart = document.getElementById('importance-comparison-chart');
            const comparisonTable = document.getElementById('importance-comparison-table');
            
            if (comparisonChart && comparisonTable) {
                // Will implement comparison visualization in the future
                comparisonChart.innerHTML = '<p>Feature importance comparison visualization will be added in a future update.</p>';
            }
        }
    }, 1000);
});
</script>