{% from "components/charts/bar_chart.html" import bar_chart %}
{% from "components/tables/data_table.html" import data_table %}
{% include "components/ui/subtabs.html" %}

<!-- Make feature importance data available globally for JavaScript functions -->
<script>
    window.feature_importance = {{ feature_importance | tojson }};
    window.model_feature_importance = {{ model_feature_importance | tojson }};
    window.feature_subset = {{ feature_subset | tojson }};
</script>

<div class="feature-importance-section">
    <div class="card">
        <h2>Feature Importance Analysis</h2>
        <p>This section shows different types of feature importance analysis to help understand which features have the greatest impact on model performance.</p>
        
        <div class="subtabs-container">
            <div class="subtabs" data-parent="features">
                <div class="subtab active" data-subtab="robustness_importance" data-parent="features">
                    Robustness Importance
                </div>
                <div class="subtab" data-subtab="model_importance" data-parent="features">
                    Model Importance
                </div>
                <div class="subtab" data-subtab="comparison" data-parent="features">
                    Importance Comparison
                </div>
            </div>
        </div>

        <!-- Robustness Importance Content -->
        <div id="robustness_importance" class="subtab-content active" data-parent="features">
            <div class="robustness-importance-container">
                <h3>Robustness Feature Importance</h3>
                <p>Higher values indicate features that have a greater impact on model robustness when perturbed.</p>
                
                <div id="feature-importance-container">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <div id="feature-importance-table">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Model Importance Content -->
        <div id="model_importance" class="subtab-content" data-parent="features">
            <div class="model-importance-container">
                <h3>Model Feature Importance</h3>
                <p>Features with higher scores have greater impact on the model's predictions according to the model's internal metrics.</p>
                
                <div id="model-features-container">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <div id="model-features-table">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Comparison Content -->
        <div id="comparison" class="subtab-content" data-parent="features">
            <div class="importance-comparison-container">
                <h3>Feature Importance Comparison</h3>
                <p>This visualization compares robustness importance with model-derived importance to identify any differences.</p>
                
                <div id="importance-comparison-container">
                    <p>The visualizations below compare robustness-based feature importance with the model's internal feature importance metrics.</p>
                    
                    <div class="chart-selector">
                        <button class="chart-btn active" id="barChartBtn">Bar Chart</button>
                        <button class="chart-btn" id="scatterChartBtn">Scatter Plot</button>
                        <button class="chart-btn" id="radarChartBtn">Radar Chart</button>
                        <button class="chart-btn" id="heatmapBtn">Heatmap</button>
                        <button class="chart-btn" id="rankingBtn">Ranking</button>
                    </div>
                    
                    <script>
                        // Add event listeners for importance chart buttons once DOM is loaded
                        document.addEventListener('DOMContentLoaded', function() {
                            const setupImportanceChart = function(btnId, chartType) {
                                document.getElementById(btnId).addEventListener('click', function() {
                                    // Remove active class from all buttons
                                    document.querySelectorAll('.chart-btn').forEach(btn => {
                                        btn.classList.remove('active');
                                    });
                                    
                                    // Add active class to clicked button
                                    this.classList.add('active');
                                    
                                    // Hide all charts
                                    document.querySelectorAll('.importance-chart').forEach(chart => {
                                        chart.style.display = 'none';
                                    });
                                    
                                    // Show selected chart
                                    const chartMap = {
                                        'bar': 'importance-bar-chart',
                                        'scatter': 'importance-scatter-chart',
                                        'radar': 'importance-radar-chart',
                                        'heatmap': 'importance-heatmap',
                                        'ranking': 'importance-ranking'
                                    };
                                    
                                    const chartId = chartMap[chartType];
                                    if (chartId) {
                                        const chartElement = document.getElementById(chartId);
                                        if (chartElement) {
                                            chartElement.style.display = 'block';
                                            // Trigger resize for proper rendering
                                            window.dispatchEvent(new Event('resize'));
                                        }
                                    }
                                    
                                    return false;
                                });
                            };
                            
                            // Setup all buttons
                            setupImportanceChart('barChartBtn', 'bar');
                            setupImportanceChart('scatterChartBtn', 'scatter');
                            setupImportanceChart('radarChartBtn', 'radar');
                            setupImportanceChart('heatmapBtn', 'heatmap');
                            setupImportanceChart('rankingBtn', 'ranking');
                        });
                    </script>
                    
                    <!-- Bar Chart -->
                    <div id="importance-bar-chart" class="importance-chart active" style="height: 500px;"></div>
                    
                    <!-- Scatter Plot -->
                    <div id="importance-scatter-chart" class="importance-chart" style="height: 500px; display: none;"></div>
                    
                    <!-- Radar Chart -->
                    <div id="importance-radar-chart" class="importance-chart" style="height: 500px; display: none;"></div>
                    
                    <!-- Heatmap -->
                    <div id="importance-heatmap" class="importance-chart" style="height: 500px; display: none;"></div>
                    
                    <!-- Ranking Comparison -->
                    <div id="importance-ranking" class="importance-chart" style="height: 500px; display: none;"></div>
                    
                    <div class="analysis-section mt-4">
                        <h4>Feature Importance Analysis</h4>
                        <p>This analysis compares two different methods of measuring feature importance:</p>
                        <ul>
                            <li><strong>Model Feature Importance:</strong> The intrinsic importance calculated by the model itself, showing which features most influence predictions.</li>
                            <li><strong>Robustness Feature Importance:</strong> Measures how much model performance changes when each feature is perturbed, indicating robustness.</li>
                        </ul>
                        <p>Key insights:</p>
                        <ul>
                            <li>Features that rank high on both metrics are both influential and robust.</li>
                            <li>Features with high model importance but low robustness importance may be vulnerable to perturbations.</li>
                            <li>The subset of features highlighted in the visualization represents the optimal balance between predictive power and robustness.</li>
                        </ul>
                    </div>
                    
                    <div id="importance-comparison-table" class="mt-4">
                        <!-- Will be populated by JavaScript if both sets of data are available -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .feature-importance-section {
        margin-bottom: 30px;
    }
    
    .card {
        margin-bottom: 30px;
    }
    
    .robustness-importance-container,
    .model-importance-container,
    .importance-comparison-container {
        margin-bottom: 20px;
    }
    
    .robustness-importance-container h3,
    .model-importance-container h3,
    .importance-comparison-container h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
        color: #2c3e50;
    }
    
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .feature-table {
        margin-top: 20px;
        width: 100%;
        border-collapse: collapse;
    }
    
    .feature-table th, .feature-table td {
        padding: 8px 12px;
        text-align: left;
        border: 1px solid #ddd;
    }
    
    .feature-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .feature-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    #feature-importance-container,
    #model-features-container,
    .importance-chart {
        min-height: 400px;
        margin: 20px 0;
    }
    
    .chart-selector {
        display: flex;
        justify-content: center;
        margin: 15px 0;
        flex-wrap: wrap;
    }
    
    .chart-btn {
        padding: 8px 16px;
        margin: 5px;
        background-color: #f1f1f1;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        color: #333;
    }
    
    .chart-btn:hover {
        background-color: #e0e0e0;
    }
    
    .chart-btn.active {
        background-color: #1b78de;
        color: white;
    }
    
    .analysis-section {
        background-color: #f8f9fa;
        border-left: 4px solid #1b78de;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 4px 4px 0;
    }
    
    .analysis-section h4 {
        color: #1b78de;
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 16px;
    }
    
    .analysis-section ul {
        margin-bottom: 15px;
    }
    
    .mt-4 {
        margin-top: 25px;
    }
</style>

<!-- Add JavaScript to generate comparison charts -->
<script>
// Listen for both DOMContentLoaded and the custom renderCharts event
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded - initializing feature importance charts");
    initializeCharts();
});

document.addEventListener('renderCharts', function() {
    console.log("renderCharts event received - initializing feature importance charts");
    initializeCharts();
});

// Main chart initialization function with multiple attempts
function initializeCharts() {
    // First attempt - immediate
    try {
        console.log("First attempt to render importance comparison charts");
        renderImportanceComparisonCharts();
    } catch (e) {
        console.warn("First attempt failed:", e);
    }
    
    // Second attempt - short delay for Plotly to load
    setTimeout(function() {
        try {
            console.log("Second attempt to render importance comparison charts");
            renderImportanceComparisonCharts();
        } catch (e) {
            console.warn("Second attempt failed:", e);
        }
        
        // Third attempt - longer delay in case other resources are still loading
        setTimeout(function() {
            try {
                console.log("Final attempt to render importance comparison charts");
                renderImportanceComparisonCharts();
            } catch (e) {
                console.error("All chart rendering attempts failed:", e);
            }
        }, 2000);
    }, 500);
}

// Function to show different importance chart types
function showImportanceChart(chartType) {
    try {
        console.log("Showing chart type:", chartType);
        
        // Fallback to 'bar' if chartType is invalid
        if (!chartType || typeof chartType !== 'string') {
            console.warn("Invalid chart type, defaulting to 'bar'");
            chartType = 'bar';
        }
        
        // Map button IDs (match the actual IDs in the HTML)
        const buttonIdMap = {
            'bar': 'barChartBtn',
            'scatter': 'scatterChartBtn',
            'radar': 'radarChartBtn',
            'heatmap': 'heatmapBtn',
            'ranking': 'rankingBtn'
        };
        
        // First, check to make sure all our DOM elements exist
        let allElementsExist = true;
        const buttonIds = Object.values(buttonIdMap);
        
        buttonIds.forEach(id => {
            if (!document.getElementById(id)) {
                console.error(`Button element with ID '${id}' not found in the DOM`);
                allElementsExist = false;
            }
        });
        
        // Check chart containers too
        const chartIdMap = {
            'bar': 'importance-bar-chart',
            'scatter': 'importance-scatter-chart',
            'radar': 'importance-radar-chart',
            'heatmap': 'importance-heatmap',
            'ranking': 'importance-ranking'
        };
        
        const chartIds = Object.values(chartIdMap);
        chartIds.forEach(id => {
            if (!document.getElementById(id)) {
                console.error(`Chart container with ID '${id}' not found in the DOM`);
                allElementsExist = false;
            }
        });
        
        if (!allElementsExist) {
            console.warn("Some UI elements are missing - chart switching may not work properly");
        }
        
        // Update active button - use the correct ID from our map
        const chartButtons = document.querySelectorAll('.chart-btn');
        if (chartButtons && chartButtons.length > 0) {
            chartButtons.forEach(btn => {
                btn.classList.remove('active');
            });
        } else {
            console.warn("No chart buttons found with class '.chart-btn'");
        }
        
        // Get button ID safely
        const buttonId = buttonIdMap[chartType] || 'barChartBtn';
        const buttonElement = document.getElementById(buttonId);
        
        if (buttonElement) {
            buttonElement.classList.add('active');
        } else {
            console.error("Button element not found for ID:", buttonId);
        }
        
        // Hide all charts
        const chartElements = document.querySelectorAll('.importance-chart');
        if (chartElements && chartElements.length > 0) {
            chartElements.forEach(chart => {
                chart.style.display = 'none';
            });
        } else {
            console.warn("No chart containers found with class '.importance-chart'");
        }
        
        // Get chart element safely
        const chartId = chartIdMap[chartType] || 'importance-bar-chart';
        const chartElement = document.getElementById(chartId);
        
        if (chartElement) {
            console.log("Displaying chart:", chartId);
            chartElement.style.display = 'block';
            // Trigger resize to ensure chart renders properly
            window.dispatchEvent(new Event('resize'));
        } else {
            console.error("Chart element not found for ID:", chartId);
            // Try to show any chart as a fallback
            const fallbackChart = document.getElementById('importance-bar-chart');
            if (fallbackChart) {
                fallbackChart.style.display = 'block';
            }
        }
    } catch (error) {
        console.error("Error in showImportanceChart:", error);
    }
    
    // Return false to prevent default button action
    return false;
}

// Main function to render all comparison charts
function renderImportanceComparisonCharts() {
    try {
        console.log("Starting to render importance comparison charts");
        
        // Debug: check what data is directly available from window globals
        console.log("Direct debug check of window globals:");
        console.log("- window.feature_importance:", window.feature_importance);
        console.log("- window.model_feature_importance:", window.model_feature_importance);
        console.log("- window.feature_subset:", window.feature_subset);
        
        // Get feature importance data
        const featureData = getFeatureImportanceData();
        
        if (!featureData || !featureData.combined || featureData.combined.length === 0) {
            console.warn("No feature importance data available");
            showNoDataAvailableMessages();
            return;
        }
        
        console.log("Feature importance data loaded successfully:", featureData);
        
        // Render all chart types - with detailed logging and error handling
        try {
            console.log("Rendering bar chart...");
            renderBarChart(featureData);
            console.log("Bar chart rendered successfully");
        } catch (e) {
            console.error("Error rendering bar chart:", e);
        }
        
        try {
            console.log("Rendering scatter plot...");
            renderScatterPlot(featureData);
            console.log("Scatter plot rendered successfully");
        } catch (e) {
            console.error("Error rendering scatter plot:", e);
        }
        
        try {
            console.log("Rendering radar chart...");
            renderRadarChart(featureData);
            console.log("Radar chart rendered successfully");
        } catch (e) {
            console.error("Error rendering radar chart:", e);
        }
        
        try {
            console.log("Rendering heatmap...");
            renderHeatmap(featureData);
            console.log("Heatmap rendered successfully");
        } catch (e) {
            console.error("Error rendering heatmap:", e);
        }
        
        try {
            console.log("Rendering ranking comparison...");
            renderRankingComparison(featureData);
            console.log("Ranking comparison rendered successfully");
        } catch (e) {
            console.error("Error rendering ranking comparison:", e);
        }
        
        try {
            console.log("Rendering comparison table...");
            renderComparisonTable(featureData);
            console.log("Comparison table rendered successfully");
        } catch (e) {
            console.error("Error rendering comparison table:", e);
        }
        
        // Force a pre-rendering of all chart types to ensure they're properly initialized
        console.log("Pre-rendering all charts to ensure initialization...");
        
        // Store current chart visibility
        const chartVisibility = {};
        document.querySelectorAll('.importance-chart').forEach(chart => {
            chartVisibility[chart.id] = chart.style.display;
        });
        
        // Make all charts temporarily visible but not displayed (opacity 0)
        document.querySelectorAll('.importance-chart').forEach(chart => {
            chart.style.display = 'block';
            chart.style.opacity = '0';
        });
        
        // Trigger a resize to ensure charts render
        window.dispatchEvent(new Event('resize'));
        
        // Restore original visibility after a short delay
        setTimeout(() => {
            document.querySelectorAll('.importance-chart').forEach(chart => {
                chart.style.display = chartVisibility[chart.id] || 'none';
                chart.style.opacity = '1';
            });
            console.log("Chart visibility restored");
        }, 100);

        // Render the individual feature importance tables and charts
        try {
            console.log("Rendering robustness importance visualization...");
            renderRobustnessImportanceVisualizations(featureData);
        } catch (e) {
            console.error("Error rendering robustness importance visualization:", e);
        }

        try {
            console.log("Rendering model feature importance visualization...");
            renderModelFeatureImportanceVisualizations(featureData);
        } catch (e) {
            console.error("Error rendering model feature importance visualization:", e);
        }
        
    } catch (error) {
        console.error("Fatal error in renderImportanceComparisonCharts:", error);
        showNoDataAvailableMessages();
    }
}

// Function to render all robustness importance visualizations
function renderRobustnessImportanceVisualizations(data) {
    renderRobustnessImportanceChart(data);
    renderRobustnessImportanceTable(data);
}

// Function to render all model feature importance visualizations
function renderModelFeatureImportanceVisualizations(data) {
    renderModelFeatureImportanceChart(data);
    renderModelFeatureImportanceTable(data);
}

// Function to render the robustness importance chart
function renderRobustnessImportanceChart(data) {
    const container = document.getElementById('feature-importance-container');
    if (!container) {
        console.error("Robustness importance chart container not found");
        return;
    }
    
    try {
        // Sort data by robustness importance in descending order
        const sortedData = [...data.combined].sort((a, b) => b.robustness_importance - a.robustness_importance).slice(0, 15);
        
        // Extract data for the chart
        const features = sortedData.map(item => item.feature);
        const importanceValues = sortedData.map(item => item.robustness_importance);
        const colors = sortedData.map(item => item.in_subset ? 'rgba(46, 204, 113, 0.8)' : 'rgba(46, 204, 113, 0.4)');
        
        // Create a horizontal bar chart
        const trace = {
            x: importanceValues,
            y: features,
            type: 'bar',
            orientation: 'h',
            marker: {
                color: colors,
                line: {
                    color: 'rgba(46, 204, 113, 1.0)',
                    width: 1
                }
            }
        };
        
        const layout = {
            title: 'Robustness Feature Importance',
            xaxis: {
                title: 'Importance Score',
                range: [0, Math.max(...importanceValues) * 1.1]
            },
            yaxis: {
                title: 'Feature',
                automargin: true
            },
            margin: {
                l: 150,
                r: 30,
                t: 50,
                b: 50
            },
            annotations: [
                {
                    x: 0.99,
                    y: 0.98,
                    xref: 'paper',
                    yref: 'paper',
                    text: 'Darker bars indicate selected subset features',
                    showarrow: false,
                    font: {
                        size: 10,
                        color: '#777'
                    }
                }
            ]
        };
        
        Plotly.newPlot(container, [trace], layout);
        
    } catch (error) {
        console.error("Error rendering robustness importance chart:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering chart: ${error.message}</div>`;
    }
}

// Function to render the model feature importance chart
function renderModelFeatureImportanceChart(data) {
    const container = document.getElementById('model-features-container');
    if (!container) {
        console.error("Model feature importance chart container not found");
        return;
    }
    
    try {
        // Sort data by model importance in descending order
        const sortedData = [...data.combined].sort((a, b) => b.model_importance - a.model_importance).slice(0, 15);
        
        // Extract data for the chart
        const features = sortedData.map(item => item.feature);
        const importanceValues = sortedData.map(item => item.model_importance);
        const colors = sortedData.map(item => item.in_subset ? 'rgba(27, 120, 222, 0.8)' : 'rgba(27, 120, 222, 0.4)');
        
        // Create a horizontal bar chart
        const trace = {
            x: importanceValues,
            y: features,
            type: 'bar',
            orientation: 'h',
            marker: {
                color: colors,
                line: {
                    color: 'rgba(27, 120, 222, 1.0)',
                    width: 1
                }
            }
        };
        
        const layout = {
            title: 'Model Feature Importance',
            xaxis: {
                title: 'Importance Score',
                range: [0, Math.max(...importanceValues) * 1.1]
            },
            yaxis: {
                title: 'Feature',
                automargin: true
            },
            margin: {
                l: 150,
                r: 30,
                t: 50,
                b: 50
            },
            annotations: [
                {
                    x: 0.99,
                    y: 0.98,
                    xref: 'paper',
                    yref: 'paper',
                    text: 'Darker bars indicate selected subset features',
                    showarrow: false,
                    font: {
                        size: 10,
                        color: '#777'
                    }
                }
            ]
        };
        
        Plotly.newPlot(container, [trace], layout);
        
    } catch (error) {
        console.error("Error rendering model feature importance chart:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering chart: ${error.message}</div>`;
    }
}

// Function to render the robustness importance table
function renderRobustnessImportanceTable(data) {
    const container = document.getElementById('feature-importance-table');
    if (!container) {
        console.error("Robustness importance table container not found");
        return;
    }

    // Clear any existing content in the container first
    container.innerHTML = '';
    
    try {
        // Sort data by robustness importance in descending order
        const sortedData = [...data.combined].sort((a, b) => b.robustness_importance - a.robustness_importance);
        
        // Create robustness importance table
        let html = `
        <h4>Robustness Feature Importance Ranking</h4>
        <table class="feature-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Robustness Importance Score</th>
                    <th>Rank</th>
                    <th>In Optimal Subset</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        // Add rows for each feature
        sortedData.forEach((item, index) => {
            const isInSubset = item.in_subset;
            const rowClass = isInSubset ? 'class="highlight-row"' : '';
            
            html += `
            <tr ${rowClass}>
                <td>${item.feature}</td>
                <td>${item.robustness_importance.toFixed(4)}</td>
                <td>${index + 1}</td>
                <td>${isInSubset ? '✓' : '—'}</td>
            </tr>
            `;
        });
        
        html += `
            </tbody>
        </table>
        <p class="mt-4"><small>Features with higher robustness importance scores have greater impact on model behavior when perturbed. 
        Features in the optimal subset are highlighted.</small></p>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error("Error rendering robustness importance table:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering importance table: ${error.message}</div>`;
    }
}

// Function to render the model feature importance table
function renderModelFeatureImportanceTable(data) {
    const container = document.getElementById('model-features-table');
    if (!container) {
        console.error("Model feature importance table container not found");
        return;
    }
    
    // Clear any existing content in the container first
    container.innerHTML = '';
    
    try {
        // Sort data by model importance in descending order
        const sortedData = [...data.combined].sort((a, b) => b.model_importance - a.model_importance);
        
        // Create model importance table
        let html = `
        <h4>Model Feature Importance Ranking</h4>
        <table class="feature-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Model Importance Score</th>
                    <th>Rank</th>
                    <th>In Optimal Subset</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        // Add rows for each feature
        sortedData.forEach((item, index) => {
            const isInSubset = item.in_subset;
            const rowClass = isInSubset ? 'class="highlight-row"' : '';
            
            html += `
            <tr ${rowClass}>
                <td>${item.feature}</td>
                <td>${item.model_importance.toFixed(4)}</td>
                <td>${index + 1}</td>
                <td>${isInSubset ? '✓' : '—'}</td>
            </tr>
            `;
        });
        
        html += `
            </tbody>
        </table>
        <p class="mt-4"><small>Features with higher model importance scores have greater impact on the model's predictions according to the model's internal metrics. 
        Features in the optimal subset are highlighted.</small></p>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error("Error rendering model importance table:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering model importance table: ${error.message}</div>`;
    }
}

// Function to extract and prepare feature importance data
function getFeatureImportanceData() {
    let featureImportance = null;
    let modelFeatureImportance = null;
    let featureSubset = null;
    let modelType = null;
    
    // CHANGE: First check for global template variables - prioritize these over other data sources
    if (window.feature_importance && window.model_feature_importance) {
        console.log("Found feature importance data in global template variables");
        featureImportance = window.feature_importance;
        modelFeatureImportance = window.model_feature_importance;
        featureSubset = window.feature_subset || [];
        // Try to get model type from reportData if available
        modelType = (window.reportData && window.reportData.model_type) || "Unknown Model";
        
        console.log("Using global variables: feature_importance has", Object.keys(featureImportance).length, "features");
        console.log("Using global variables: model_feature_importance has", Object.keys(modelFeatureImportance).length, "features");
    }
    // If not available in global variables, try reportData
    else {
        console.log("Falling back to reportData for feature importance data");
        
        // Try to get data directly from reportData
        if (window.reportData) {
            console.log("reportData is available with keys:", Object.keys(window.reportData));
            
            // Check direct paths first - be more lenient with empty objects
            if (reportData.feature_importance && reportData.model_feature_importance) {
                console.log("Found feature importance data in direct path");
                featureImportance = reportData.feature_importance;
                modelFeatureImportance = reportData.model_feature_importance;
                featureSubset = reportData.feature_subset || [];
                modelType = reportData.model_type || "Unknown Model";
            } 
            // Check if nested within primary_model (most common case)
            else if (reportData.primary_model && 
                    reportData.primary_model.feature_importance && 
                    reportData.primary_model.model_feature_importance) {
                
                console.log("Found feature importance data in primary_model path");
                featureImportance = reportData.primary_model.feature_importance;
                modelFeatureImportance = reportData.primary_model.model_feature_importance;
                featureSubset = reportData.primary_model.feature_subset || [];
                modelType = reportData.primary_model.model_type || "Unknown Model";
            }
            // Try to get from nested structure with results.robustness path
            else if (reportData.results && 
                    reportData.results.robustness && 
                    reportData.results.robustness.results && 
                    reportData.results.robustness.results.primary_model) {
                
                console.log("Checking nested path with results.robustness.results.primary_model");
                const primaryModel = reportData.results.robustness.results.primary_model;
                console.log("Primary model keys:", Object.keys(primaryModel));
                
                if (primaryModel.feature_importance && primaryModel.model_feature_importance) {
                    console.log("Found feature importance data in nested path");
                    featureImportance = primaryModel.feature_importance;
                    modelFeatureImportance = primaryModel.model_feature_importance;
                    featureSubset = primaryModel.feature_subset || [];
                    modelType = primaryModel.model_type || "Unknown Model";
                }
            }
            // Try alternate location - template might have data in report_data property
            else if (reportData.report_data && 
                    reportData.report_data.feature_importance && 
                    reportData.report_data.model_feature_importance) {
                
                console.log("Found feature importance data in report_data property");
                featureImportance = reportData.report_data.feature_importance;
                modelFeatureImportance = reportData.report_data.model_feature_importance;
                featureSubset = reportData.report_data.feature_subset || [];
                modelType = reportData.report_data.model_type || "Unknown Model";
            }
        }
    }
    
    // If no data found, display a message
    if (!featureImportance || !modelFeatureImportance) {
        console.warn("No feature importance data available. Paths checked:", 
                    "reportData.feature_importance", 
                    "reportData.primary_model.feature_importance",
                    "reportData.results.robustness.results.primary_model.feature_importance");
        return null;
    }
    
    console.log("Successfully found feature importance data:", 
                "featureImportance keys:", Object.keys(featureImportance).length,
                "modelFeatureImportance keys:", Object.keys(modelFeatureImportance).length);
    
    // Combine the data for easier processing
    const combined = [];
    const allFeatures = new Set([
        ...Object.keys(featureImportance),
        ...Object.keys(modelFeatureImportance)
    ]);
    
    allFeatures.forEach(feature => {
        combined.push({
            feature: feature,
            robustness_importance: featureImportance[feature] || 0,
            model_importance: modelFeatureImportance[feature] || 0,
            in_subset: featureSubset.includes(feature)
        });
    });
    
    // Sort by model importance
    combined.sort((a, b) => b.model_importance - a.model_importance);
    
    // Compute rankings
    const robustnessRanking = [...combined].sort((a, b) => b.robustness_importance - a.robustness_importance);
    const modelRanking = [...combined].sort((a, b) => b.model_importance - a.model_importance);
    
    robustnessRanking.forEach((item, index) => {
        const matchingItem = combined.find(i => i.feature === item.feature);
        if (matchingItem) {
            matchingItem.robustness_rank = index + 1;
        }
    });
    
    modelRanking.forEach((item, index) => {
        const matchingItem = combined.find(i => i.feature === item.feature);
        if (matchingItem) {
            matchingItem.model_rank = index + 1;
        }
    });
    
    // Calculate rank difference
    combined.forEach(item => {
        item.rank_diff = Math.abs(item.model_rank - item.robustness_rank);
    });
    
    return {
        combined: combined,
        featureSubset: featureSubset,
        modelType: modelType
    };
}

// Function to show no data available message
function showNoDataAvailableMessages() {
    // Display no data message in all chart containers
    const containers = [
        'feature-importance-container',
        'feature-importance-table',
        'model-features-container',
        'model-features-table',
        'importance-bar-chart',
        'importance-scatter-chart',
        'importance-radar-chart',
        'importance-heatmap',
        'importance-ranking',
        'importance-comparison-table'
    ];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="alert alert-info" style="margin: 20px 0;">
                    <h4 style="margin-top: 0;">Data not available</h4>
                    <p>Feature importance data is not available for this analysis. This may occur if:</p>
                    <ul>
                        <li>The robustness test has not been run</li>
                        <li>The model does not support feature importance calculation</li>
                        <li>The analysis is still in progress</li>
                    </ul>
                </div>
            `;
        }
    });
}

// Function to render bar chart comparison
function renderBarChart(data) {
    const container = document.getElementById('importance-bar-chart');
    if (!container) return;
    
    try {
        // Get top 10 features by model importance
        const topFeatures = data.combined.slice(0, 10);
        
        // Prepare data for side-by-side bar chart
        const features = topFeatures.map(item => item.feature);
        const modelImportance = topFeatures.map(item => item.model_importance);
        const robustnessImportance = topFeatures.map(item => item.robustness_importance);
        const inSubset = topFeatures.map(item => item.in_subset);
        
        // Create bar colors with higher opacity for subset features
        const modelColors = topFeatures.map(item => 
            item.in_subset ? 'rgba(27, 120, 222, 0.9)' : 'rgba(27, 120, 222, 0.5)'
        );
        
        const robustnessColors = topFeatures.map(item => 
            item.in_subset ? 'rgba(46, 204, 113, 0.9)' : 'rgba(46, 204, 113, 0.5)'
        );
        
        // Create traces for plotly
        const modelTrace = {
            x: features,
            y: modelImportance,
            name: 'Model Importance',
            type: 'bar',
            marker: {
                color: modelColors,
                line: {
                    color: 'rgba(27, 120, 222, 1.0)',
                    width: 1
                }
            }
        };
        
        const robustnessTrace = {
            x: features,
            y: robustnessImportance,
            name: 'Robustness Importance',
            type: 'bar',
            marker: {
                color: robustnessColors,
                line: {
                    color: 'rgba(46, 204, 113, 1.0)',
                    width: 1
                }
            }
        };
        
        const layout = {
            title: 'Feature Importance Comparison (Top 10 Features)',
            barmode: 'group',
            xaxis: {
                title: 'Feature',
                tickangle: -45
            },
            yaxis: {
                title: 'Importance Score',
                range: [0, 1]
            },
            legend: {
                orientation: 'h',
                y: -0.2
            },
            margin: {
                l: 50,
                r: 30,
                t: 50,
                b: 120
            },
            annotations: data.featureSubset.length > 0 ? [
                {
                    x: 0.95,
                    y: 0.95,
                    xref: 'paper',
                    yref: 'paper',
                    text: '* Darker bars indicate selected subset features',
                    showarrow: false,
                    font: {
                        size: 10,
                        color: '#555'
                    }
                }
            ] : []
        };
        
        Plotly.newPlot(container, [modelTrace, robustnessTrace], layout);
    } catch (error) {
        console.error("Error rendering bar chart:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering bar chart: ${error.message}</div>`;
    }
}

// Function to render scatter plot of importance values
function renderScatterPlot(data) {
    const container = document.getElementById('importance-scatter-chart');
    if (!container) return;
    
    try {
        // Prepare data for scatter plot
        const features = data.combined.map(item => item.feature);
        const modelImportance = data.combined.map(item => item.model_importance);
        const robustnessImportance = data.combined.map(item => item.robustness_importance);
        const inSubset = data.combined.map(item => item.in_subset);
        
        // Create marker colors and sizes
        const markerColors = data.combined.map(item => 
            item.in_subset ? 'rgba(255, 115, 0, 1.0)' : 'rgba(135, 155, 188, 0.7)'
        );
        
        const markerSizes = data.combined.map(item => 
            item.in_subset ? 12 : 8
        );
        
        // Create scatter trace
        const scatterTrace = {
            x: modelImportance,
            y: robustnessImportance,
            mode: 'markers+text',
            type: 'scatter',
            text: features,
            textposition: 'top',
            textfont: {
                size: 10,
                color: 'rgba(0, 0, 0, 0.6)'
            },
            marker: {
                size: markerSizes,
                color: markerColors,
                line: {
                    color: 'rgba(0, 0, 0, 0.3)',
                    width: 1
                }
            },
            hovertemplate: 
                '<b>%{text}</b><br>' +
                'Model Importance: %{x:.4f}<br>' +
                'Robustness Importance: %{y:.4f}<br>' +
                '<extra></extra>'
        };
        
        // Draw quadrant lines
        const xMean = modelImportance.reduce((a, b) => a + b, 0) / modelImportance.length;
        const yMean = robustnessImportance.reduce((a, b) => a + b, 0) / robustnessImportance.length;
        
        const vLine = {
            type: 'line',
            x0: xMean,
            y0: 0,
            x1: xMean,
            y1: 1,
            line: {
                color: 'rgba(0, 0, 0, 0.3)',
                width: 1,
                dash: 'dash'
            }
        };
        
        const hLine = {
            type: 'line',
            x0: 0,
            y0: yMean,
            x1: 1,
            y1: yMean,
            line: {
                color: 'rgba(0, 0, 0, 0.3)',
                width: 1,
                dash: 'dash'
            }
        };
        
        // Create annotations for quadrants
        const annotations = [
            {
                x: xMean / 2,
                y: yMean / 2,
                text: 'Low Importance,<br>Low Robustness',
                showarrow: false,
                font: { size: 10, color: '#777' }
            },
            {
                x: (1 + xMean) / 2,
                y: yMean / 2,
                text: 'High Importance,<br>Low Robustness',
                showarrow: false,
                font: { size: 10, color: '#777' }
            },
            {
                x: xMean / 2,
                y: (1 + yMean) / 2,
                text: 'Low Importance,<br>High Robustness',
                showarrow: false,
                font: { size: 10, color: '#777' }
            },
            {
                x: (1 + xMean) / 2,
                y: (1 + yMean) / 2,
                text: 'High Importance,<br>High Robustness',
                showarrow: false,
                font: { size: 10, color: '#777' }
            }
        ];
        
        const layout = {
            title: 'Model vs. Robustness Feature Importance',
            xaxis: {
                title: 'Model Feature Importance',
                range: [0, Math.max(...modelImportance) * 1.1]
            },
            yaxis: {
                title: 'Robustness Feature Importance',
                range: [0, Math.max(...robustnessImportance) * 1.1]
            },
            shapes: [vLine, hLine],
            annotations: [
                ...annotations,
                {
                    x: 0.95,
                    y: 0.05,
                    xref: 'paper',
                    yref: 'paper',
                    text: '* Larger orange points indicate selected subset features',
                    showarrow: false,
                    font: {
                        size: 10,
                        color: '#555'
                    }
                }
            ],
            margin: {
                l: 50,
                r: 30,
                t: 50,
                b: 60
            },
            hovermode: 'closest'
        };
        
        Plotly.newPlot(container, [scatterTrace], layout);
    } catch (error) {
        console.error("Error rendering scatter plot:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering scatter plot: ${error.message}</div>`;
    }
}

// Function to render radar chart of top features
function renderRadarChart(data) {
    const container = document.getElementById('importance-radar-chart');
    if (!container) return;
    
    try {
        // Get top 8 features by combined importance
        const combinedImportance = data.combined.map(item => 
            item.model_importance + item.robustness_importance
        );
        
        const combinedData = data.combined.map((item, index) => ({
            ...item,
            combined_importance: combinedImportance[index]
        }));
        
        const topFeatures = [...combinedData]
            .sort((a, b) => b.combined_importance - a.combined_importance)
            .slice(0, 8);
        
        const features = topFeatures.map(item => item.feature);
        const modelImportance = topFeatures.map(item => item.model_importance);
        const robustnessImportance = topFeatures.map(item => item.robustness_importance);
        
        // Add first point again to close the polygon
        features.push(features[0]);
        modelImportance.push(modelImportance[0]);
        robustnessImportance.push(robustnessImportance[0]);
        
        const modelTrace = {
            r: modelImportance,
            theta: features,
            name: 'Model Importance',
            type: 'scatterpolar',
            fill: 'toself',
            fillcolor: 'rgba(27, 120, 222, 0.3)',
            line: {
                color: 'rgba(27, 120, 222, 0.8)',
                width: 2
            }
        };
        
        const robustnessTrace = {
            r: robustnessImportance,
            theta: features,
            name: 'Robustness Importance',
            type: 'scatterpolar',
            fill: 'toself',
            fillcolor: 'rgba(46, 204, 113, 0.3)',
            line: {
                color: 'rgba(46, 204, 113, 0.8)',
                width: 2
            }
        };
        
        const layout = {
            title: 'Feature Importance Radar Chart (Top 8 Features)',
            polar: {
                radialaxis: {
                    visible: true,
                    range: [0, 1]
                }
            },
            legend: {
                orientation: 'h',
                y: -0.2
            },
            margin: {
                l: 50,
                r: 50,
                t: 50,
                b: 60
            }
        };
        
        Plotly.newPlot(container, [modelTrace, robustnessTrace], layout);
    } catch (error) {
        console.error("Error rendering radar chart:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering radar chart: ${error.message}</div>`;
    }
}

// Function to render heatmap of feature importance
function renderHeatmap(data) {
    const container = document.getElementById('importance-heatmap');
    if (!container) return;
    
    try {
        // Get top 15 features by combined importance
        const combinedImportance = data.combined.map(item => 
            item.model_importance + item.robustness_importance
        );
        
        const combinedData = data.combined.map((item, index) => ({
            ...item,
            combined_importance: combinedImportance[index]
        }));
        
        const topFeatures = [...combinedData]
            .sort((a, b) => b.combined_importance - a.combined_importance)
            .slice(0, 15);
        
        const features = topFeatures.map(item => item.feature);
        
        // Create 2D data array for heatmap
        const z = [
            topFeatures.map(item => item.model_importance),
            topFeatures.map(item => item.robustness_importance)
        ];
        
        const heatmapTrace = {
            z: z,
            x: features,
            y: ['Model Importance', 'Robustness Importance'],
            type: 'heatmap',
            colorscale: 'Viridis',
            colorbar: {
                title: 'Importance',
                titleside: 'right'
            },
            hoverongaps: false,
            hovertemplate: 
                '<b>Feature:</b> %{x}<br>' +
                '<b>Type:</b> %{y}<br>' +
                '<b>Importance:</b> %{z:.4f}' +
                '<extra></extra>'
        };
        
        // Create annotations to show which features are in the subset
        const annotations = features.map((feature, index) => {
            const isInSubset = topFeatures.find(item => item.feature === feature).in_subset;
            
            return isInSubset ? {
                x: index,
                y: 0.5,  // Middle between the two rows
                text: '★',
                showarrow: false,
                font: {
                    color: 'rgba(255, 255, 255, 0.8)',
                    size: 16
                },
                hoverlabel: {
                    bgcolor: '#333'
                },
                hovertext: 'Feature in optimal subset'
            } : null;
        }).filter(Boolean);
        
        const layout = {
            title: 'Feature Importance Heatmap',
            xaxis: {
                title: 'Feature',
                tickangle: -45
            },
            yaxis: {
                title: 'Importance Type'
            },
            annotations: [
                ...annotations,
                {
                    x: 1.05,
                    y: -0.15,
                    xref: 'paper',
                    yref: 'paper',
                    text: '★ indicates feature is in the optimal subset',
                    showarrow: false,
                    font: {
                        size: 10,
                        color: '#555'
                    }
                }
            ],
            margin: {
                l: 150,
                r: 30,
                t: 50,
                b: 120
            }
        };
        
        Plotly.newPlot(container, [heatmapTrace], layout);
    } catch (error) {
        console.error("Error rendering heatmap:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering heatmap: ${error.message}</div>`;
    }
}

// Function to render ranking comparison
function renderRankingComparison(data) {
    const container = document.getElementById('importance-ranking');
    if (!container) return;
    
    try {
        // Get top 15 features by rank difference (most disputed rankings)
        const topByDifference = [...data.combined]
            .sort((a, b) => b.rank_diff - a.rank_diff)
            .slice(0, 15);
        
        const features = topByDifference.map(item => item.feature);
        const modelRanks = topByDifference.map(item => item.model_rank);
        const robustnessRanks = topByDifference.map(item => item.robustness_rank);
        const inSubset = topByDifference.map(item => item.in_subset);
        
        // Create marker style based on subset
        const markerColors = topByDifference.map(item => 
            item.in_subset ? 'rgba(255, 115, 0, 1.0)' : 'rgba(135, 155, 188, 0.7)'
        );
        
        const markerSizes = topByDifference.map(item => 
            item.in_subset ? 12 : 8
        );
        
        // Create traces for ranking comparison
        const modelTrace = {
            x: features,
            y: modelRanks,
            type: 'scatter',
            mode: 'markers+lines',
            name: 'Model Importance Rank',
            marker: {
                symbol: 'circle',
                size: markerSizes,
                color: 'rgba(27, 120, 222, 0.8)',
                line: {
                    color: 'white',
                    width: 1
                }
            },
            line: {
                color: 'rgba(27, 120, 222, 0.4)',
                width: 1,
                dash: 'dot'
            }
        };
        
        const robustnessTrace = {
            x: features,
            y: robustnessRanks,
            type: 'scatter',
            mode: 'markers+lines',
            name: 'Robustness Importance Rank',
            marker: {
                symbol: 'circle',
                size: markerSizes,
                color: 'rgba(46, 204, 113, 0.8)',
                line: {
                    color: 'white',
                    width: 1
                }
            },
            line: {
                color: 'rgba(46, 204, 113, 0.4)',
                width: 1,
                dash: 'dot'
            }
        };
        
        // Create shapes to highlight rank differences
        const shapes = features.map((feature, index) => {
            const rankDiff = Math.abs(modelRanks[index] - robustnessRanks[index]);
            const color = rankDiff > 10 ? 'rgba(231, 76, 60, 0.2)' : 
                          rankDiff > 5 ? 'rgba(241, 196, 15, 0.2)' : 
                          'rgba(46, 204, 113, 0.1)';
            
            return {
                type: 'rect',
                x0: index - 0.4,
                x1: index + 0.4,
                y0: Math.min(modelRanks[index], robustnessRanks[index]),
                y1: Math.max(modelRanks[index], robustnessRanks[index]),
                fillcolor: color,
                line: {
                    width: 0
                }
            };
        });
        
        const layout = {
            title: 'Feature Importance Ranking Comparison',
            xaxis: {
                title: 'Feature',
                tickangle: -45
            },
            yaxis: {
                title: 'Rank (1 = highest importance)',
                autorange: 'reversed', // Reverse y-axis so rank 1 is at the top
                tickmode: 'linear',
                tick0: 0,
                dtick: 5
            },
            shapes: shapes,
            legend: {
                orientation: 'h',
                y: -0.2
            },
            margin: {
                l: 50,
                r: 30,
                t: 50,
                b: 120
            },
            annotations: [
                {
                    x: 0.95,
                    y: 0.95,
                    xref: 'paper',
                    yref: 'paper',
                    text: 'Shaded areas show rank differences',
                    showarrow: false,
                    font: {
                        size: 10,
                        color: '#555'
                    }
                }
            ]
        };
        
        Plotly.newPlot(container, [modelTrace, robustnessTrace], layout);
    } catch (error) {
        console.error("Error rendering ranking comparison:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering ranking comparison: ${error.message}</div>`;
    }
}

// Function to render comparison table
function renderComparisonTable(data) {
    const container = document.getElementById('importance-comparison-table');
    if (!container) return;
    
    try {
        // Sort features by model importance for the table
        const sortedData = [...data.combined].sort((a, b) => b.model_importance - a.model_importance);
        
        // Create table HTML
        let html = `
        <h4>Feature Importance Comparison Table</h4>
        <table class="feature-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Model Importance</th>
                    <th>Robustness Importance</th>
                    <th>Model Rank</th>
                    <th>Robustness Rank</th>
                    <th>Rank Difference</th>
                    <th>In Optimal Subset</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        // Add rows for each feature
        sortedData.forEach(item => {
            const isInSubset = item.in_subset;
            const rowClass = isInSubset ? 'class="highlight-row"' : '';
            
            html += `
            <tr ${rowClass}>
                <td>${item.feature}</td>
                <td>${item.model_importance.toFixed(4)}</td>
                <td>${item.robustness_importance.toFixed(4)}</td>
                <td>${item.model_rank}</td>
                <td>${item.robustness_rank}</td>
                <td>${item.rank_diff}</td>
                <td>${isInSubset ? '✓' : '—'}</td>
            </tr>
            `;
        });
        
        html += `
            </tbody>
        </table>
        `;
        
        container.innerHTML = html;
        
        // Add highlight row style if not already defined
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            .highlight-row {
                background-color: rgba(255, 249, 219, 0.7) !important;
                font-weight: 500;
            }
        `;
        document.head.appendChild(styleElement);
    } catch (error) {
        console.error("Error rendering comparison table:", error);
        container.innerHTML = `<div class="alert alert-warning">Error rendering comparison table: ${error.message}</div>`;
    }
}
</script>