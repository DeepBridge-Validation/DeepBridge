{% extends "base.html" %}

{% block title %}DeepBridge Resilience Report{% endblock %}

{% block head %}
<style>
    .resilience-score-indicator {
        text-align: center;
        margin: 30px 0;
    }
    
    .score-circle {
        display: inline-block;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: conic-gradient(
            var(--primary-color) calc({{ resilience_score|float * 360 }}deg),
            #e9ecef calc({{ resilience_score|float * 360 }}deg) 360deg
        );
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .score-inner {
        position: absolute;
        top: 15px;
        left: 15px;
        right: 15px;
        bottom: 15px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    
    .score-value {
        font-size: 32px;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .score-label {
        font-size: 14px;
        color: #666;
    }
    
    .metrics-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metrics-container > div {
        flex: 1 0 250px;
    }
    
    @media (max-width: 768px) {
        .metrics-container > div {
            flex: 1 0 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
    {# Summary Section #}
    {% include "report_types/resilience/summary.html" %}
    
    {# Tabs Navigation #}
    {% from "components/ui/tabs.html" import tabs %}
    {{ tabs([
        {"id": "overview", "title": "Overview", "active": true},
        {"id": "distribution", "title": "Distribution Shift"},
        {"id": "details", "title": "Detailed Results"}
    ]) }}
    
    {# Tab Contents #}
    <div id="overview" class="tab-content active">
        {% include "report_types/resilience/overview.html" %}
    </div>
    
    <div id="distribution" class="tab-content">
        {% include "report_types/resilience/distribution.html" %}
    </div>
    
    <div id="details" class="tab-content">
        {% include "report_types/resilience/details.html" %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize with report data
    document.addEventListener('DOMContentLoaded', function() {
        // Parse the report data
        window.reportData = JSON.parse('{{ report_data_json|safe }}');
        console.log('Report data loaded:', reportData);
        
        // Ensure Plotly is loaded
        if (typeof Plotly === 'undefined') {
            console.error('Plotly is not loaded. Loading it dynamically...');
            var script = document.createElement('script');
            script.src = 'https://cdn.plot.ly/plotly-2.29.1.min.js';
            script.onload = function() {
                console.log('Plotly loaded successfully');
                // Trigger rendering of all charts
                renderAllCharts();
            };
            document.head.appendChild(script);
        } else {
            console.log('Plotly is already loaded');
            // Small delay to ensure the DOM is fully ready
            setTimeout(renderAllCharts, 100);
        }
        
        // Function to trigger all chart renderings
        function renderAllCharts() {
            // Dispatch a custom event that component scripts will listen for
            document.dispatchEvent(new CustomEvent('renderCharts'));
        }
    });
</script>
{% endblock %}

{% block component_scripts %}
<script>
    // Function to render all resilience charts
    function renderAllResilienceCharts() {
        if (!window.reportData || typeof Plotly === 'undefined') {
            console.error('Cannot render resilience charts: reportData or Plotly not available');
            return;
        }
        console.log('Rendering all resilience charts...');

    // Scripts from component templates run here after reportData is initialized
        // Initialize charts and tables based on reportData
        
        // Distribution shift charts
        const distributionContainer = document.getElementById('distribution-shift-container');
        if (distributionContainer && reportData.distribution_shift_results) {
            // Process and display distribution shifts...
        }
        
        // Detail tables
        const detailsContainer = document.getElementById('shift-results-container');
        if (detailsContainer && reportData.distribution_shift_results) {
            // Create detailed tables...
        }
    } // End of renderAllResilienceCharts function
    
    // Call render function when DOM is loaded
    document.addEventListener('DOMContentLoaded', renderAllResilienceCharts);
    
    // Also listen for the custom event triggered after reportData is loaded
    document.addEventListener('renderCharts', renderAllResilienceCharts);
</script>
{% endblock %}