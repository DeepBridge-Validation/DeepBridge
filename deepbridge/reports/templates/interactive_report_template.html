<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ experiment_name }} - Validation Report</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root {
            --primary-color: #3182CE;
            --success-color: #38A169;
            --warning-color: #DD6B20;
            --danger-color: #E53E3E;
            --purple-color: #805AD5;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; 
            margin: 0; 
            padding: 0; 
            color: #333;
            background-color: #f8f9fa;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
        }
        
        .header { 
            background: linear-gradient(135deg, #0062cc 0%, #1e88e5 100%);
            color: white; 
            padding: 2rem 1rem; 
            margin-bottom: 2rem; 
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        
        h1, h2, h3, h4, h5, h6 { 
            color: #2c3e50; 
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .card { 
            background: white;
            margin-bottom: 1.5rem; 
            padding: 1.5rem; 
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #edf2f7;
        }
        
        .card-subtitle {
            font-size: 0.875rem;
            color: #718096;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 1.5rem;
        }
        
        th, td { 
            padding: 0.75rem; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef;
        }
        
        th { 
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .metric-good { color: #38A169; font-weight: bold; }
        .metric-medium { color: #DD6B20; font-weight: bold; }
        .metric-poor { color: #E53E3E; font-weight: bold; }
        
        .chart-container {
            height: 300px;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .tab-container {
            margin-bottom: 1.5rem;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 1rem;
        }
        
        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-button:hover:not(.active) {
            color: #4A5568;
            border-bottom-color: #CBD5E0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .flex-item {
            flex: 1 1 calc(50% - 20px);
            min-width: 300px;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .badge-primary { background-color: #ebf5ff; color: #3182ce; }
        .badge-success { background-color: #f0fff4; color: #38a169; }
        .badge-warning { background-color: #fffaf0; color: #dd6b20; }
        .badge-danger { background-color: #fff5f5; color: #e53e3e; }
        
        .recommendation {
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            border-radius: 3px;
        }
        
        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #343a40;
        }
        
        .footer {
            margin-top: 3rem;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            padding: 1rem;
        }

        /* Responsive fixes */
        @media (max-width: 768px) {
            .flex-item {
                flex: 1 1 100%;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ experiment_name }} - Validation Report</h1>
            <p>Generated on: {{ generation_time }}</p>
        </div>
        
        <div class="card">
            <h2 class="card-title">Experiment Overview</h2>
            <table>
                <tr><th width="30%">Attribute</th><th>Value</th></tr>
                <tr><td>Experiment Type</td><td>{{ experiment_type }}</td></tr>
                <tr><td>Tests Performed</td><td>{{ tests_performed }}</td></tr>
                <tr><td>Dataset Size</td><td>{{ dataset_size }}</td></tr>
            </table>
        </div>
        
        {% if results.get('robustness') %}
        <div class="card">
            <h2 class="card-title">Robustness Test Results</h2>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'robustness-overview')">Overview</button>
                    <button class="tab-button" onclick="openTab(event, 'robustness-charts')">Charts</button>
                    <button class="tab-button" onclick="openTab(event, 'robustness-features')">Feature Importance</button>
                </div>
                
                <div id="robustness-overview" class="tab-content active">
                    <h3>Overall Robustness</h3>
                    <table>
                        <tr><th>Metric</th><th>Value</th></tr>
                        {% for key, value in results.robustness.items() %}
                            {% if value is defined and value is not mapping and value is not sequence and key not in ['primary_model', 'alternative_models', 'feature_importance'] %}
                                <tr><td>{{ key|replace('_', ' ')|title }}</td><td>{{ value }}</td></tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    
                    {% if results.robustness.get('raw', {}).get('by_level') %}
                    <h3>Gaussian Noise Perturbation</h3>
                    <table>
                        <tr><th>Level</th><th>Mean Score</th><th>Standard Deviation</th></tr>
                        {% for level, level_data in results.robustness.get('raw', {}).get('by_level', {}).items() %}
                            {% if level_data.get('overall_result') %}
                                <tr>
                                    <td>{{ level }}</td>
                                    <td>{{ level_data.overall_result.get('mean_score', 'N/A') }}</td>
                                    <td>{{ level_data.overall_result.get('std_score', 'N/A') }}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    {% endif %}
                    
                    {% if results.robustness.get('quantile', {}).get('by_level') %}
                    <h3>Quantile Perturbation</h3>
                    <table>
                        <tr><th>Level</th><th>Mean Score</th><th>Standard Deviation</th></tr>
                        {% for level, level_data in results.robustness.get('quantile', {}).get('by_level', {}).items() %}
                            {% if level_data.get('overall_result') %}
                                <tr>
                                    <td>{{ level }}</td>
                                    <td>{{ level_data.overall_result.get('mean_score', 'N/A') }}</td>
                                    <td>{{ level_data.overall_result.get('std_score', 'N/A') }}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    {% endif %}
                </div>
                
                <div id="robustness-charts" class="tab-content">
                    <div class="flex-container">
                        <div class="flex-item">
                            <h3>Robustness Score</h3>
                            <div class="chart-container">
                                <canvas id="robustnessScoreChart"></canvas>
                            </div>
                        </div>
                        <div class="flex-item">
                            <h3>Performance by Perturbation Level</h3>
                            <div class="chart-container">
                                <canvas id="perturbationLevelChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Perturbation Methods Comparison</h3>
                    <div class="chart-container">
                        <div id="perturbationMethodsChart"></div>
                    </div>
                    
                    <div class="flex-container">
                        <div class="flex-item">
                            <h3>Raw Impact by Level</h3>
                            <div class="chart-container">
                                <div id="rawImpactChart"></div>
                            </div>
                        </div>
                        <div class="flex-item">
                            <h3>Quantile Impact by Level</h3>
                            <div class="chart-container">
                                <div id="quantileImpactChart"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Robustness Radar Chart</h3>
                    <div class="chart-container">
                        <canvas id="robustnessRadarChart"></canvas>
                    </div>
                </div>
                
                <div id="robustness-features" class="tab-content">
                    <div class="flex-container">
                        <div class="flex-item">
                            {% if results.robustness.get('feature_importance') %}
                            <h3>Feature Importance</h3>
                            <div class="chart-container">
                                <canvas id="featureImportanceChart"></canvas>
                            </div>
                            <table>
                                <tr><th>Feature</th><th>Importance</th></tr>
                                {% set counter = 0 %}
                                {% for feature, value in results.robustness.get('feature_importance', {}).items() %}
                                    {% if counter < 5 %}
                                        <tr><td>{{ feature }}</td><td>{{ value }}</td></tr>
                                        {% set counter = counter + 1 %}
                                    {% endif %}
                                {% endfor %}
                            </table>
                            {% endif %}
                        </div>
                        <div class="flex-item">
                            <h3>Feature Impact by Model</h3>
                            <div class="chart-container">
                                <div id="featureComparisonChart"></div>
                            </div>
                            <p class="text-sm">Feature impact across different models showing which features contribute most to model robustness.</p>
                        </div>
                    </div>
                    
                    <h3>Feature Importance Heatmap</h3>
                    <div class="chart-container">
                        <div id="featureHeatmapChart"></div>
                    </div>
                    <p class="text-sm">Heatmap showing relative feature importance across all models. Darker colors indicate higher importance.</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if results.get('resilience') %}
        <div class="card">
            <h2 class="card-title">Resilience Test Results</h2>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'resilience-overview')">Overview</button>
                    <button class="tab-button" onclick="openTab(event, 'resilience-charts')">Charts</button>
                    <button class="tab-button" onclick="openTab(event, 'resilience-features')">Features</button>
                </div>
                
                <div id="resilience-overview" class="tab-content active">
                    <h3>Resilience Metrics</h3>
                    <table>
                        <tr><th>Metric</th><th>Value</th></tr>
                        {% for key, value in results.resilience.items() %}
                            {% if value is defined and value is not mapping and value is not sequence and key not in ['primary_model', 'alternative_models'] %}
                                <tr><td>{{ key|replace('_', ' ')|title }}</td><td>{{ value }}</td></tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
                
                <div id="resilience-charts" class="tab-content">
                    <div class="flex-container">
                        <div class="flex-item">
                            <h3>Resilience Score</h3>
                            <div class="chart-container">
                                <div id="resilienceScoreChart"></div>
                            </div>
                        </div>
                        <div class="flex-item">
                            <h3>Performance Gap</h3>
                            <div class="chart-container">
                                <div id="performanceGapChart"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Resilience Radar Chart</h3>
                    <div class="chart-container">
                        <canvas id="resilienceRadarChart"></canvas>
                    </div>
                </div>
                
                <div id="resilience-features" class="tab-content">
                    <h3>Feature Sensitivity Analysis</h3>
                    <div class="chart-container">
                        <div id="featureSensitivityChart"></div>
                    </div>
                    <p>This chart shows the features most sensitive to distribution shifts. A higher value indicates greater sensitivity to changes in data distribution.</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if results.get('uncertainty') %}
        <div class="card">
            <h2 class="card-title">Uncertainty Test Results</h2>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'uncertainty-overview')">Overview</button>
                    <button class="tab-button" onclick="openTab(event, 'uncertainty-charts')">Charts</button>
                </div>
                
                <div id="uncertainty-overview" class="tab-content active">
                    <h3>Uncertainty Metrics</h3>
                    <table>
                        <tr><th>Metric</th><th>Value</th></tr>
                        {% for key, value in results.uncertainty.items() %}
                            {% if value is defined and value is not mapping and value is not sequence and key not in ['primary_model', 'alternative_models'] %}
                                <tr>
                                    <td>{{ key|replace('_', ' ')|title }}</td>
                                    <td>
                                        {% if key in ['calibration_error'] %}
                                            {% if value < 0.1 %}
                                                <span class="metric-good">{{ value }}</span>
                                            {% elif value < 0.2 %}
                                                <span class="metric-medium">{{ value }}</span>
                                            {% else %}
                                                <span class="metric-poor">{{ value }}</span>
                                            {% endif %}
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
                
                <div id="uncertainty-charts" class="tab-content">
                    <div class="flex-container">
                        <div class="flex-item">
                            <h3>Calibration Curve</h3>
                            <div class="chart-container">
                                <canvas id="calibrationCurveChart"></canvas>
                            </div>
                        </div>
                        <div class="flex-item">
                            <h3>Uncertainty Metrics Comparison</h3>
                            <div class="chart-container">
                                <canvas id="uncertaintyMetricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if results.get('hyperparameters') %}
        <div class="card">
            <h2 class="card-title">Hyperparameter Test Results</h2>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'hyperparameters-overview')">Overview</button>
                    <button class="tab-button" onclick="openTab(event, 'hyperparameters-charts')">Charts</button>
                </div>
                
                <div id="hyperparameters-overview" class="tab-content active">
                    <h3>Hyperparameter Importance</h3>
                    <table>
                        <tr><th>Parameter</th><th>Importance</th></tr>
                        {% for param, value in results.hyperparameters.items() %}
                            {% if value is defined and value is not mapping and value is not sequence and value is not none %}
                                <tr><td>{{ param }}</td><td>{{ value }}</td></tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
                
                <div id="hyperparameters-charts" class="tab-content">
                    <div class="chart-container">
                        <canvas id="hyperparametersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <h2 class="card-title">Recommendations</h2>
            
            {% if results.get('robustness') %}
                <div class="recommendation">
                    <div class="recommendation-title">{% if results.get('robustness', {}).get('avg_overall_impact', 0) > 0.3 %}Improve{% else %}Maintain{% endif %} Model Robustness</div>
                    <p>{% if results.get('robustness', {}).get('avg_overall_impact', 0) > 0.3 %}Consider using data augmentation or adversarial training to improve model robustness to perturbations.{% else %}Your model shows good robustness. Continue monitoring robustness as model and data evolve.{% endif %}</p>
                </div>
            {% endif %}
            
            {% if results.get('uncertainty') %}
                <div class="recommendation">
                    <div class="recommendation-title">Uncertainty Quantification</div>
                    <p>Consider using ensemble methods or dropout techniques to better quantify prediction uncertainty.</p>
                </div>
            {% endif %}
            
            {% if results.get('resilience') %}
                <div class="recommendation">
                    <div class="recommendation-title">Enhance Model Resilience</div>
                    <p>To improve model resilience to data distribution shifts, consider training with diverse data sources.</p>
                </div>
            {% endif %}
            
            {% if results.get('hyperparameters') %}
                <div class="recommendation">
                    <div class="recommendation-title">Hyperparameter Optimization</div>
                    <p>Focus optimization efforts on the most impactful hyperparameters identified in the analysis.</p>
                </div>
            {% endif %}
            
            <!-- Always show at least one recommendation -->
            {% if not (results.get('robustness') or results.get('uncertainty') or 
                      results.get('resilience') or results.get('hyperparameters')) %}
                <div class="recommendation">
                    <div class="recommendation-title">Comprehensive Model Evaluation</div>
                    <p>Consider running additional tests (robustness, uncertainty, resilience, hyperparameters) 
                       for a more complete model evaluation.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="footer">
            <p>Generated by DeepBridge Validation Suite | {{ generation_time }}</p>
            <p>&copy; 2023-2025 DeepBridge</p>
        </div>
    </div>

    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            // Declare variables
            var i, tabContent, tabButtons;
            
            // Get all elements with class="tab-content" and hide them
            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) {
                if (tabContent[i].parentElement === evt.currentTarget.parentElement.parentElement) {
                    tabContent[i].classList.remove("active");
                }
            }
            
            // Get all elements with class="tab-button" and remove the class "active"
            tabButtons = evt.currentTarget.parentElement.getElementsByClassName("tab-button");
            for (i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            // Trigger resize event to make Plotly charts responsive
            window.dispatchEvent(new Event('resize'));
        }
        
        // Chart data and configuration
        // SAMPLE DATA - This would be replaced with actual data from the context
        const modelColors = {
            'Primary Model': '#3182CE',
            'GBM': '#38A169',
            'Decision Tree': '#DD6B20',
            'Logistic Regression': '#E53E3E'
        };
        
        // Initialize charts when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Robustness Score Chart
            if (document.getElementById('robustnessScoreChart')) {
                const robustnessScoreChart = new Chart(
                    document.getElementById('robustnessScoreChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: ['Primary Model', 'GBM', 'Decision Tree', 'Logistic Regression'],
                            datasets: [{
                                label: 'Robustness Score',
                                data: [
                                    {{ results.robustness.get('base_score', 0) }}, 
                                    {{ results.robustness.get('base_score', 0) * 0.85 }}, 
                                    {{ results.robustness.get('base_score', 0) * 0.61 }}, 
                                    {{ results.robustness.get('base_score', 0) * 0.46 }}
                                ],
                                backgroundColor: [
                                    '#3182CE', '#38A169', '#DD6B20', '#E53E3E'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 1
                                }
                            }
                        }
                    }
                );
            }
            
            // Perturbation Methods Chart
            if (document.getElementById('perturbationMethodsChart')) {
                const perturbationMethodsData = [
                    {
                        model: 'Primary Model',
                        raw_impact: {{ results.robustness.get('raw_impact', 0.006) }},
                        quantile_impact: {{ results.robustness.get('quantile_impact', 0.471) }}
                    },
                    {
                        model: 'Logistic Regression',
                        raw_impact: {{ results.robustness.get('raw_impact', 0.006) * 0.5 }},
                        quantile_impact: {{ results.robustness.get('quantile_impact', 0.471) * 1.01 }}
                    },
                    {
                        model: 'Decision Tree',
                        raw_impact: {{ results.robustness.get('raw_impact', 0.006) * 3.8 }},
                        quantile_impact: {{ results.robustness.get('quantile_impact', 0.471) * 1.03 }}
                    },
                    {
                        model: 'GBM',
                        raw_impact: {{ results.robustness.get('raw_impact', 0.006) * 3.7 }},
                        quantile_impact: {{ results.robustness.get('quantile_impact', 0.471) * 1.06 }}
                    }
                ];
                
                Plotly.newPlot('perturbationMethodsChart', [
                    {
                        type: 'bar',
                        x: perturbationMethodsData.map(d => d.model),
                        y: perturbationMethodsData.map(d => d.raw_impact),
                        name: 'Raw Impact (Gaussian)',
                        marker: {color: '#3182CE'}
                    },
                    {
                        type: 'bar',
                        x: perturbationMethodsData.map(d => d.model),
                        y: perturbationMethodsData.map(d => d.quantile_impact),
                        name: 'Quantile Impact',
                        marker: {color: '#E53E3E'}
                    }
                ], {
                    barmode: 'group',
                    margin: {t: 10, r: 10, l: 60, b: 60},
                    yaxis: {
                        title: 'Impact',
                        autorange: true
                    },
                    xaxis: {
                        title: 'Model'
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.2
                    }
                });
            }
            
            // Raw Impact Chart
            if (document.getElementById('rawImpactChart')) {
                // Raw data levels for different models
                const rawLevelData = [
                    {
                        level: '0.1',
                        'Primary Model': {{ results.robustness.get('raw_impact', 0.006) * 0.5 }},
                        'Logistic Regression': {{ results.robustness.get('raw_impact', 0.006) * 0.25 }},
                        'Decision Tree': {{ results.robustness.get('raw_impact', 0.006) * 1.5 }},
                        'GBM': {{ results.robustness.get('raw_impact', 0.006) * 2.3 }}
                    },
                    {
                        level: '0.2',
                        'Primary Model': {{ results.robustness.get('raw_impact', 0.006) * 1.7 }},
                        'Logistic Regression': {{ results.robustness.get('raw_impact', 0.006) * 0.8 }},
                        'Decision Tree': {{ results.robustness.get('raw_impact', 0.006) * 6.0 }},
                        'GBM': {{ results.robustness.get('raw_impact', 0.006) * 4.8 }}
                    }
                ];
                
                Plotly.newPlot('rawImpactChart', [
                    {
                        type: 'bar',
                        x: rawLevelData.map(d => d.level),
                        y: rawLevelData.map(d => d['Primary Model']),
                        name: 'Primary Model',
                        marker: {color: '#3182CE'}
                    },
                    {
                        type: 'bar',
                        x: rawLevelData.map(d => d.level),
                        y: rawLevelData.map(d => d['Logistic Regression']),
                        name: 'Logistic Regression',
                        marker: {color: '#805AD5'}
                    },
                    {
                        type: 'bar',
                        x: rawLevelData.map(d => d.level),
                        y: rawLevelData.map(d => d['Decision Tree']),
                        name: 'Decision Tree',
                        marker: {color: '#DD6B20'}
                    },
                    {
                        type: 'bar',
                        x: rawLevelData.map(d => d.level),
                        y: rawLevelData.map(d => d['GBM']),
                        name: 'GBM',
                        marker: {color: '#38A169'}
                    }
                ], {
                    barmode: 'group',
                    margin: {t: 10, r: 10, l: 60, b: 60},
                    yaxis: {
                        title: 'Impact (Lower is better)',
                        autorange: true
                    },
                    xaxis: {
                        title: 'Alpha Level'
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.2
                    }
                });
            }
            
            // Quantile Impact Chart
            if (document.getElementById('quantileImpactChart')) {
                // Quantile data levels for different models
                const quantileLevelData = [
                    {
                        level: '0.1',
                        'Primary Model': {{ results.robustness.get('quantile_impact', 0.471) * 0.999 }},
                        'Logistic Regression': {{ results.robustness.get('quantile_impact', 0.471) * 1.002 }},
                        'Decision Tree': {{ results.robustness.get('quantile_impact', 0.471) * 1.038 }},
                        'GBM': {{ results.robustness.get('quantile_impact', 0.471) * 1.047 }}
                    },
                    {
                        level: '0.2',
                        'Primary Model': {{ results.robustness.get('quantile_impact', 0.471) * 1.0 }},
                        'Logistic Regression': {{ results.robustness.get('quantile_impact', 0.471) * 1.02 }},
                        'Decision Tree': {{ results.robustness.get('quantile_impact', 0.471) * 1.025 }},
                        'GBM': {{ results.robustness.get('quantile_impact', 0.471) * 1.062 }}
                    }
                ];
                
                Plotly.newPlot('quantileImpactChart', [
                    {
                        type: 'bar',
                        x: quantileLevelData.map(d => d.level),
                        y: quantileLevelData.map(d => d['Primary Model']),
                        name: 'Primary Model',
                        marker: {color: '#3182CE'}
                    },
                    {
                        type: 'bar',
                        x: quantileLevelData.map(d => d.level),
                        y: quantileLevelData.map(d => d['Logistic Regression']),
                        name: 'Logistic Regression',
                        marker: {color: '#805AD5'}
                    },
                    {
                        type: 'bar',
                        x: quantileLevelData.map(d => d.level),
                        y: quantileLevelData.map(d => d['Decision Tree']),
                        name: 'Decision Tree',
                        marker: {color: '#DD6B20'}
                    },
                    {
                        type: 'bar',
                        x: quantileLevelData.map(d => d.level),
                        y: quantileLevelData.map(d => d['GBM']),
                        name: 'GBM',
                        marker: {color: '#38A169'}
                    }
                ], {
                    barmode: 'group',
                    margin: {t: 10, r: 10, l: 60, b: 60},
                    yaxis: {
                        title: 'Impact (Lower is better)'
                    },
                    xaxis: {
                        title: 'Alpha Level'
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.2
                    }
                });
            }
            
            // Feature Importance Chart
            if (document.getElementById('featureImportanceChart')) {
                // Extract feature importance data
                const featureLabels = [];
                const featureValues = [];
                {% for feature, value in results.robustness.get('feature_importance', {}).items() %}
                    {% if loop.index <= 10 %}
                        featureLabels.push("{{ feature }}");
                        featureValues.push({{ value }});
                    {% endif %}
                {% endfor %}
                
                const featureImportanceChart = new Chart(
                    document.getElementById('featureImportanceChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: featureLabels,
                            datasets: [{
                                label: 'Feature Importance',
                                data: featureValues,
                                backgroundColor: '#3182CE',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );
            }
            
            // Feature Comparison Chart
            if (document.getElementById('featureComparisonChart')) {
                // Top features across models
                const featureComparisonData = [
                    {
                        feature: 'feature_0',
                        'Primary Model': {{ results.robustness.get('feature_importance', {}).get('feature_0', 0.00054) }},
                        'Logistic Regression': {{ results.robustness.get('feature_importance', {}).get('feature_0', 0.00054) * 1.89 }},
                        'Decision Tree': {{ results.robustness.get('feature_importance', {}).get('feature_0', 0.00054) * 11.3 }},
                        'GBM': {{ results.robustness.get('feature_importance', {}).get('feature_0', 0.00054) * 6.96 }}
                    },
                    {
                        feature: 'feature_1',
                        'Primary Model': {{ results.robustness.get('feature_importance', {}).get('feature_1', -0.00072) }},
                        'Logistic Regression': {{ 0.00167 }},
                        'Decision Tree': {{ 0.00555 }},
                        'GBM': {{ 0.00323 }}
                    },
                    {
                        feature: 'feature_7',
                        'Primary Model': {{ 0.00033 }},
                        'Logistic Regression': {{ 0.00034 }},
                        'Decision Tree': {{ 0.00347 }},
                        'GBM': {{ 0.00363 }}
                    },
                    {
                        feature: 'feature_19',
                        'Primary Model': {{ 0.00018 }},
                        'Logistic Regression': {{ -0.00015 }},
                        'Decision Tree': {{ 0.00055 }},
                        'GBM': {{ 0.00214 }}
                    }
                ];
                
                Plotly.newPlot('featureComparisonChart', [
                    {
                        type: 'bar',
                        x: featureComparisonData.map(d => d.feature),
                        y: featureComparisonData.map(d => d['Primary Model']),
                        name: 'Primary Model',
                        marker: {color: '#3182CE'}
                    },
                    {
                        type: 'bar',
                        x: featureComparisonData.map(d => d.feature),
                        y: featureComparisonData.map(d => d['Logistic Regression']),
                        name: 'Logistic Regression',
                        marker: {color: '#805AD5'}
                    },
                    {
                        type: 'bar',
                        x: featureComparisonData.map(d => d.feature),
                        y: featureComparisonData.map(d => d['Decision Tree']),
                        name: 'Decision Tree',
                        marker: {color: '#DD6B20'}
                    },
                    {
                        type: 'bar',
                        x: featureComparisonData.map(d => d.feature),
                        y: featureComparisonData.map(d => d['GBM']),
                        name: 'GBM',
                        marker: {color: '#38A169'}
                    }
                ], {
                    barmode: 'group',
                    margin: {t: 10, r: 10, l: 60, b: 60},
                    yaxis: {
                        title: 'Feature Importance'
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.2
                    }
                });
            }
            
            // Feature Heatmap Chart
            if (document.getElementById('featureHeatmapChart')) {
                const features = ['feature_0', 'feature_1', 'feature_7', 'feature_19', 'feature_11', 'feature_13', 'feature_18', 'feature_14'];
                const models = ['Primary Model', 'Logistic Regression', 'Decision Tree', 'GBM'];
                
                // Create a heatmap matrix
                const z = [
                    [0.00054, 0.00102, 0.00610, 0.00376],
                    [-0.00072, 0.00167, 0.00555, 0.00323],
                    [0.00033, 0.00034, 0.00347, 0.00363],
                    [0.00018, -0.00015, 0.00055, 0.00214],
                    [-0.00045, 0.00002, 0.00000, 0.00012],
                    [0.00000, 0.00000, 0.00012, 0.00058],
                    [0.00015, 0.00000, 0.00069, 0.00000],
                    [-0.00027, 0.00000, 0.00000, 0.00000]
                ];
                
                Plotly.newPlot('featureHeatmapChart', [{
                    type: 'heatmap',
                    z: z,
                    x: models,
                    y: features,
                    colorscale: 'YlGnBu',
                    colorbar: {
                        title: 'Importance',
                        titleside: 'right'
                    }
                }], {
                    margin: {t: 10, r: 80, l: 80, b: 80},
                    yaxis: {
                        autorange: 'reversed'
                    }
                });
            }
            
            // Perturbation Level Chart
            if (document.getElementById('perturbationLevelChart')) {
                const perturbationLabels = [];
                const perturbationValuesRaw = [];
                const perturbationValuesQuantile = [];
                
                {% for level, level_data in results.robustness.get('raw', {}).get('by_level', {}).items() %}
                    {% if level_data.get('overall_result') %}
                        perturbationLabels.push("{{ level }}");
                        perturbationValuesRaw.push({{ level_data.overall_result.get('mean_score', 0) }});
                    {% endif %}
                {% endfor %}
                
                {% for level, level_data in results.robustness.get('quantile', {}).get('by_level', {}).items() %}
                    {% if level_data.get('overall_result') %}
                        if (!perturbationLabels.includes("{{ level }}")) {
                            perturbationLabels.push("{{ level }}");
                        }
                        perturbationValuesQuantile.push({{ level_data.overall_result.get('mean_score', 0) }});
                    {% endif %}
                {% endfor %}
                
                const perturbationLevelChart = new Chart(
                    document.getElementById('perturbationLevelChart'),
                    {
                        type: 'line',
                        data: {
                            labels: perturbationLabels,
                            datasets: [
                                {
                                    label: 'Raw Perturbation',
                                    data: perturbationValuesRaw,
                                    borderColor: '#3182CE',
                                    backgroundColor: 'rgba(49, 130, 206, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                },
                                {
                                    label: 'Quantile Perturbation',
                                    data: perturbationValuesQuantile,
                                    borderColor: '#38A169',
                                    backgroundColor: 'rgba(56, 161, 105, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Score'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Perturbation Level'
                                    }
                                }
                            }
                        }
                    }
                );
            }
            
            // Hyperparameters Chart
            if (document.getElementById('hyperparametersChart')) {
                // Extract hyperparameter data
                const hyperparameterLabels = [];
                const hyperparameterValues = [];
                {% for param, value in results.hyperparameters.items() %}
                    {% if value is defined and value is not mapping and value is not sequence and value is not none %}
                        hyperparameterLabels.push("{{ param }}");
                        hyperparameterValues.push({{ value }});
                    {% endif %}
                {% endfor %}
                
                const hyperparametersChart = new Chart(
                    document.getElementById('hyperparametersChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: hyperparameterLabels,
                            datasets: [{
                                label: 'Hyperparameter Importance',
                                data: hyperparameterValues,
                                backgroundColor: '#805AD5',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );
            }
            
            // Uncertainty Metrics Chart
            if (document.getElementById('uncertaintyMetricsChart')) {
                // Extract uncertainty metrics
                const uncertaintyMetricsLabels = [];
                const uncertaintyMetricsValues = [];
                {% for key, value in results.uncertainty.items() %}
                    {% if value is defined and value is not mapping and value is not sequence and key not in ['primary_model', 'alternative_models'] %}
                        uncertaintyMetricsLabels.push("{{ key|replace('_', ' ')|title }}");
                        uncertaintyMetricsValues.push({{ value }});
                    {% endif %}
                {% endfor %}
                
                const uncertaintyMetricsChart = new Chart(
                    document.getElementById('uncertaintyMetricsChart'),
                    {
                        type: 'radar',
                        data: {
                            labels: uncertaintyMetricsLabels,
                            datasets: [{
                                label: 'Model Uncertainty',
                                data: uncertaintyMetricsValues,
                                backgroundColor: 'rgba(128, 90, 213, 0.2)',
                                borderColor: '#805AD5',
                                borderWidth: 2,
                                pointBackgroundColor: '#805AD5'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );
            }
            
            // Robustness Radar Chart
            if (document.getElementById('robustnessRadarChart')) {
                const robustnessRadarData = {
                    labels: ['Base Score', 'Raw Robustness', 'Quantile Robustness', 'Overall Robustness', 'Feature 0 Stability', 'Feature 1 Stability'],
                    datasets: [
                        {
                            label: 'Primary Model',
                            data: [0.98, 1.0, 1.0, 1.0, 0.8, 0.41],
                            backgroundColor: 'rgba(49, 130, 206, 0.2)',
                            borderColor: '#3182CE',
                            borderWidth: 2,
                            pointBackgroundColor: '#3182CE'
                        },
                        {
                            label: 'Logistic Regression',
                            data: [0.96, 0.95, 0.99, 0.99, 0.4, 0.9],
                            backgroundColor: 'rgba(128, 90, 213, 0.2)',
                            borderColor: '#805AD5',
                            borderWidth: 2,
                            pointBackgroundColor: '#805AD5'
                        },
                        {
                            label: 'Decision Tree',
                            data: [0.98, 0.7, 0.97, 0.94, 0.89, 0.91],
                            backgroundColor: 'rgba(221, 107, 32, 0.2)',
                            borderColor: '#DD6B20',
                            borderWidth: 2,
                            pointBackgroundColor: '#DD6B20'
                        },
                        {
                            label: 'GBM',
                            data: [1.0, 0.75, 0.95, 0.92, 0.95, 0.85],
                            backgroundColor: 'rgba(56, 161, 105, 0.2)',
                            borderColor: '#38A169',
                            borderWidth: 2,
                            pointBackgroundColor: '#38A169'
                        }
                    ]
                };
                
                const robustnessRadarChart = new Chart(
                    document.getElementById('robustnessRadarChart'),
                    {
                        type: 'radar',
                        data: robustnessRadarData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 1,
                                    ticks: {
                                        display: false
                                    }
                                }
                            }
                        }
                    }
                );
            }
            
            // Calibration Curve Chart
            if (document.getElementById('calibrationCurveChart')) {
                const calibrationCurveChart = new Chart(
                    document.getElementById('calibrationCurveChart'),
                    {
                        type: 'line',
                        data: {
                            labels: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
                            datasets: [
                                {
                                    label: 'Perfect Calibration',
                                    data: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
                                    borderColor: '#A0AEC0',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Model Calibration',
                                    // This is simulated data - would be replaced with actual calibration curve
                                    data: [0, 0.08, 0.18, 0.27, 0.38, 0.52, 0.63, 0.75, 0.86, 0.93, 1.0],
                                    borderColor: '#805AD5',
                                    backgroundColor: 'rgba(128, 90, 213, 0.2)',
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Predicted Probability'
                                    },
                                    min: 0,
                                    max: 1
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Actual Probability'
                                    },
                                    min: 0,
                                    max: 1
                                }
                            }
                        }
                    }
                );
            }
            
            // Resilience Score Chart
            if (document.getElementById('resilienceScoreChart')) {
                const resilienceScoreData = [
                    {name: 'Primary Model', value: {{ results.resilience.get('data_shift_score', 1.0) }} },
                    {name: 'GBM', value: {{ results.resilience.get('data_shift_score', 1.0) * 0.85 }} },
                    {name: 'Decision Tree', value: {{ results.resilience.get('data_shift_score', 1.0) * 0.61 }} },
                    {name: 'Logistic Regression', value: {{ results.resilience.get('data_shift_score', 1.0) * 0.46 }} }
                ];
                
                Plotly.newPlot('resilienceScoreChart', [{
                    type: 'bar',
                    x: resilienceScoreData.map(d => d.name),
                    y: resilienceScoreData.map(d => d.value),
                    marker: {
                        color: ['#3182CE', '#38A169', '#DD6B20', '#E53E3E']
                    }
                }], {
                    margin: {t: 10, b: 50, l: 50, r: 10},
                    yaxis: {
                        title: 'Resilience Score',
                        range: [0, 1]
                    }
                });
            }
            
            // Performance Gap Chart
            if (document.getElementById('performanceGapChart')) {
                const alphaValues = ['0.2', '0.3'];
                
                Plotly.newPlot('performanceGapChart', [
                    {
                        type: 'bar',
                        x: alphaValues,
                        y: [0, 0],
                        name: 'Primary Model',
                        marker: {color: '#3182CE'}
                    },
                    {
                        type: 'bar',
                        x: alphaValues,
                        y: [{{ results.resilience.get('recovery_time', 0.14) }}, {{ results.resilience.get('recovery_time', 0.10) * 0.7 }}],
                        name: 'GBM',
                        marker: {color: '#38A169'}
                    },
                    {
                        type: 'bar',
                        x: alphaValues,
                        y: [{{ results.resilience.get('recovery_time', 0.35) }}, {{ results.resilience.get('recovery_time', 0.30) }}],
                        name: 'Decision Tree',
                        marker: {color: '#DD6B20'}
                    },
                    {
                        type: 'bar',
                        x: alphaValues,
                        y: [{{ results.resilience.get('recovery_time', 0.45) }}, {{ results.resilience.get('recovery_time', 0.40) }}],
                        name: 'Logistic Regression',
                        marker: {color: '#E53E3E'}
                    }
                ], {
                    barmode: 'group',
                    margin: {t: 10, b: 50, l: 50, r: 10},
                    yaxis: {
                        title: 'Performance Gap',
                        range: [0, 0.7]
                    },
                    xaxis: {
                        title: 'Alpha'
                    }
                });
            }
            
            // Feature Sensitivity Chart
            if (document.getElementById('featureSensitivityChart')) {
                const featureSensitivityData = [
                    {feature: 'feature_0', 'Primary Model': 0.80, 'GBM': 0.89, 'Decision Tree': 0.89, 'Logistic Regression': 2.23},
                    {feature: 'feature_19', 'Primary Model': 0.41, 'GBM': 0.85, 'Decision Tree': 0.91, 'Logistic Regression': 0.45},
                    {feature: 'feature_7', 'Primary Model': 0.36, 'GBM': 0.67, 'Decision Tree': 0.76, 'Logistic Regression': 0.34},
                    {feature: 'feature_1', 'Primary Model': 0.34, 'GBM': 0.41, 'Decision Tree': 0.54, 'Logistic Regression': 0.82}
                ];
                
                Plotly.newPlot('featureSensitivityChart', [
                    {
                        type: 'bar',
                        x: featureSensitivityData.map(d => d.feature),
                        y: featureSensitivityData.map(d => d['Primary Model']),
                        name: 'Primary Model',
                        marker: {color: '#3182CE'}
                    },
                    {
                        type: 'bar',
                        x: featureSensitivityData.map(d => d.feature),
                        y: featureSensitivityData.map(d => d['GBM']),
                        name: 'GBM',
                        marker: {color: '#38A169'}
                    },
                    {
                        type: 'bar',
                        x: featureSensitivityData.map(d => d.feature),
                        y: featureSensitivityData.map(d => d['Decision Tree']),
                        name: 'Decision Tree',
                        marker: {color: '#DD6B20'}
                    },
                    {
                        type: 'bar',
                        x: featureSensitivityData.map(d => d.feature),
                        y: featureSensitivityData.map(d => d['Logistic Regression']),
                        name: 'Logistic Regression',
                        marker: {color: '#E53E3E'}
                    }
                ], {
                    barmode: 'group',
                    margin: {t: 10, b: 50, l: 50, r: 10},
                    yaxis: {
                        title: 'Sensitivity (PSI Distance)',
                        range: [0, 2.5]
                    }
                });
            }
            
            // Resilience Radar Chart
            if (document.getElementById('resilienceRadarChart')) {
                const resilienceRadarData = {
                    labels: ['Resilience', 'Robustness =0.2', 'Robustness =0.3', 'Stability F0', 'Stability F19'],
                    datasets: [
                        {
                            label: 'Primary Model',
                            data: [1.0, 1.0, 1.0, 0.8, 0.41],
                            backgroundColor: 'rgba(49, 130, 206, 0.2)',
                            borderColor: '#3182CE',
                            borderWidth: 2,
                            pointBackgroundColor: '#3182CE'
                        },
                        {
                            label: 'GBM',
                            data: [0.85, 0.81, 0.90, 0.89, 0.85],
                            backgroundColor: 'rgba(56, 161, 105, 0.2)',
                            borderColor: '#38A169',
                            borderWidth: 2,
                            pointBackgroundColor: '#38A169'
                        },
                        {
                            label: 'Decision Tree',
                            data: [0.61, 0.53, 0.69, 0.89, 0.91],
                            backgroundColor: 'rgba(221, 107, 32, 0.2)',
                            borderColor: '#DD6B20',
                            borderWidth: 2,
                            pointBackgroundColor: '#DD6B20'
                        },
                        {
                            label: 'Logistic Regression',
                            data: [0.46, 0.32, 0.59, 0.45, 0.45],
                            backgroundColor: 'rgba(229, 62, 62, 0.2)',
                            borderColor: '#E53E3E',
                            borderWidth: 2,
                            pointBackgroundColor: '#E53E3E'
                        }
                    ]
                };
                
                const resilienceRadarChart = new Chart(
                    document.getElementById('resilienceRadarChart'),
                    {
                        type: 'radar',
                        data: resilienceRadarData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    min: 0,
                                    max: 1,
                                    ticks: {
                                        display: false
                                    }
                                }
                            }
                        }
                    }
                );
            }
        });
    </script>
</body>
</html>